"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1818],{6768:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>b,frontMatter:()=>s,metadata:()=>d,toc:()=>u});var r=n(4848),o=n(8453),i=n(1470),l=n(9365);const s={},a="Debug Bazel rules_go projects",d={id:"tips/debug-bazel-go-projects",title:"Debug Bazel rules_go projects",description:"Case study: Buildozer",source:"@site/docs/tips/debug-bazel-go-projects.md",sourceDirName:"tips",slug:"/tips/debug-bazel-go-projects",permalink:"/docs/tips/debug-bazel-go-projects",draft:!1,unlisted:!1,editUrl:"https://github.com/meroton/docs/edit/main/docs/tips/debug-bazel-go-projects.md",tags:[],version:"current",frontMatter:{},sidebar:"sidebar",previous:{title:"Tips and Tricks",permalink:"/docs/tips/"},next:{title:"Non-deterministic Builds",permalink:"/docs/tips/non-deterministic-builds"}},c={},u=[{value:"Substitute path",id:"substitute-path",level:2},{value:"Initialize delve with project-specific settings",id:"initialize-delve-with-project-specific-settings",level:2},{value:"Execroot trick",id:"execroot-trick",level:2}];function h(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"debug-bazel-rules_go-projects",children:"Debug Bazel rules_go projects"})}),"\n",(0,r.jsx)(t.p,{children:"Case study: Buildozer"}),"\n",(0,r.jsxs)(t.p,{children:["The other day I needed to improve ",(0,r.jsx)(t.a,{href:"https://github.com/bazelbuild/buildtools/blob/master/buildozer/README.md",children:(0,r.jsx)(t.code,{children:"buildozer"})})," a little\nand naturally wanted to run ",(0,r.jsx)(t.code,{children:"buildozer"})," in the ",(0,r.jsx)(t.a,{href:"https://github.com/go-delve/delve/",children:(0,r.jsx)(t.code,{children:"dlv"})})," debugger.\nI learn by doing and think through debugging.\nWhere I would previously use the ",(0,r.jsx)(t.a,{href:"/docs/tips/debug-bazel-go-projects/#execroot-trick",children:"execroot trick"}),"\nto debug programs that operate on absolute paths\nit did not work for this.\n",(0,r.jsx)(t.code,{children:"buildozer"})," operates on the current working directory\nso executing it from within Bazel's output directory does not work."]}),"\n",(0,r.jsxs)(t.p,{children:["Instead I used the ",(0,r.jsx)(t.a,{href:"https://github.com/bazelbuild/rules_go/issues/1708#issuecomment-791114337",children:"substitute path technique"})," from ",(0,r.jsx)(t.a,{href:"https://github.com/bazelbuild/rules_go/",children:"rules_go"}),",\nthanks Danny!\nThis article is a little show-case\nfor how you can easily do the same in your terminal\nand with configuration your IDE too.\nIt leverages several cool ",(0,r.jsx)(t.code,{children:"dlv"})," features.\nI will show you how to:"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Debug ",(0,r.jsx)(t.code,{children:"buildozer"})]}),"\n",(0,r.jsx)(t.li,{children:"Find all the debug symbols"}),"\n",(0,r.jsx)(t.li,{children:"Manage debug symbols for multiple go projects in different bazel projects."}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["The techniques are general and work for many languages,\nonly the tooling differs.\nYou can do the same for ",(0,r.jsx)(t.code,{children:"gdb"})," and ",(0,r.jsx)(t.a,{href:"https://github.com/rr-debugger/rr",children:(0,r.jsx)(t.code,{children:"rr"})})," when building C/C++ code."]}),"\n",(0,r.jsx)(t.h2,{id:"substitute-path",children:"Substitute path"}),"\n",(0,r.jsxs)(t.p,{children:["Substitute path is a common debugger command to change where to look for debug symbols.\nPrograms compiled with debug symbols have paths to the source files,\nwhich often works well.\nBut binaries built by Bazel\nneed some extra care.\nFor its ",(0,r.jsx)(t.em,{children:"sandbox"})," and ",(0,r.jsx)(t.em,{children:"execroot"})," directory structure\ndoes not look like the source code tree."]}),"\n",(0,r.jsxs)(t.p,{children:["One big source of confusion is the ",(0,r.jsx)(t.code,{children:"external/"})," directory\nwhere all external code is put in a flat hierarchy.\nThe code could come from any remote repository,\nor even be bundled with the source code of the program\nat an arbitrary location in the source tree."]}),"\n",(0,r.jsxs)(t.p,{children:["For the ",(0,r.jsx)(t.a,{href:"https://github.com/bazelbuild/buildtools",children:"buildtools"})," project we use the following substitute paths\nwith the ",(0,r.jsx)(t.code,{children:"<BUILDTOOLS>"})," placeholder for the repository path.\n",(0,r.jsx)(t.code,{children:"bazel-buildtools"})," is the ",(0,r.jsx)(t.a,{href:"https://bazel.build/remote/output-directories#layout",children:"convenience symlink"})," to the ",(0,r.jsx)(t.em,{children:"execroot"}),",\nif you do not build them instead use ",(0,r.jsx)(t.code,{children:"$(bazel info output_path)/.."})," to find the path."]}),"\n",(0,r.jsx)(t.p,{children:"With WORKSPACE:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'(dlv) config substitute-path external/ <BUILDTOOLS>/bazel-buildtools/external\n(dlv) config substitute-path GOROOT/   <BUILDTOOLS>/bazel-buildtools/external/go-sdk\n(dlv) config substitute-path ""        <BUILDTOOLS>/bazel-buildtools/\n'})}),"\n",(0,r.jsxs)(t.p,{children:["With MODULE.bazel the go sdk has a qualified name: ",(0,r.jsx)(t.code,{children:"rules_go~<VERSION>~go_sdk~go_default_sdk"})]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"(dlv) config substitute-path GOROOT/   <BUILDTOOLS>/bazel-buildtools/external/rules_go~0.46.0~go_sdk~go_default_sdk\n"})}),"\n",(0,r.jsx)(t.h2,{id:"initialize-delve-with-project-specific-settings",children:"Initialize delve with project-specific settings"}),"\n",(0,r.jsxs)(t.p,{children:["You ",(0,r.jsx)(t.em,{children:"could"})," use ",(0,r.jsx)(t.code,{children:"dlv"}),"'s configuration file to save these.\nIf you only work with one project that works fine.\n",(0,r.jsx)(t.em,{children:"The"})," config file is singular for your computer:\n",(0,r.jsx)(t.code,{children:"$XDG_CONFIG_HOME/dlv/config.yml"})," or ",(0,r.jsx)(t.code,{children:"~/.dlv/config.yml"}),".\nIt is a natural location for your debugging preferences,\nbut not to describe how individual projects work.\nThe config file is ",(0,r.jsx)(t.a,{href:"https://github.com/go-delve/delve/blob/master/Documentation/cli/README.md",children:"documented here"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["To set settings for a specific project\nuse the ",(0,r.jsx)(t.code,{children:"--init <command file>"})," flag.\nYou can provide any debugger commands here,\nit will initialize the debugging session\nas if they were written interactively."]}),"\n",(0,r.jsxs)(t.p,{children:["First, compile and store the path information\nwe need to debug ",(0,r.jsx)(t.code,{children:"buildozer"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"buildtools $ export BUILDTOOLS=$PWD\nbuildtools $ bazel build -c dbg //buildozer\nTarget //buildozer:buildozer up-to-date:\n  bazel-bin/buildozer/buildozer_/buildozer\nbuildtools $ export BUILDOZER=\"$(readlink bazel-bin/buildozer/buildozer_/buildozer)\"\n\n# We can now run 'buildozer' in our project.\nbuildtools $ cd /path/to/project\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Then, open ",(0,r.jsx)(t.code,{children:"buildozer"})," in the debugger.\nThis uses the shell pseudo-file redirection to in-line the commands.\nYou can also save them to a file for the project."]}),"\n",(0,r.jsxs)(i.A,{children:[(0,r.jsxs)(l.A,{value:"bash",label:"Bash",default:!0,children:[(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'project $ dlv exec --init <(echo \'\n    config substitute-path external/ \'"$BUILDTOOLS"\'/bazel-buildtools/external\n    config substitute-path GOROOT/   \'"$BUILDTOOLS"\'/bazel-buildtools/external/go-sdk\n    config substitute-path ""        \'"$BUILDTOOLS"\'/bazel-buildtools/\n    print "You can also set break points and automatically start the program."\n    break main.main\n    continue\n\') "$BUILDOZER" -- -h\n'})}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'# Create and use \'substitute-path.dlv\' for the buildtools project.\nproject $ dlv exec --init "$BUILDTOOLS"/substitute-path.dlv "$BUILDOZER" -- -h\n# Augment it with ad-hoc commands.\nproject $ dlv exec --init <( {\n    cat "$BUILDTOOLS"/substitute-path.dlv\n    echo \'break main.main\n    continue\'\n} ) $BUILDOZER -- -h\n'})})]}),(0,r.jsxs)(l.A,{value:"fish",label:"Fish",children:[(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'project $ dlv exec --init (echo \'\n    config substitute-path external/ \'"$BUILDTOOLS"\'/bazel-buildtools/external\n    config substitute-path GOROOT/   \'"$BUILDTOOLS"\'/bazel-buildtools/external/go-sdk\n    config substitute-path ""        \'"$BUILDTOOLS"\'/bazel-buildtools/\n    print "You can also set break points and automatically start the program."\n    break main.main\n    continue\n\' | psub) "$BUILDOZER" -- -h\n'})}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'# Create and use \'substitute-path.dlv\' for the buildtools project.\nproject $ dlv exec --init "$BUILDTOOLS"/substitute-path.dlv "$BUILDOZER" -- -h\n# Augment it with ad-hoc commands.\nproject $ dlv exec --init ( begin\n    cat "$BUILDTOOLS"/substitute-path.dlv\n    echo \'break main.main\n    continue\'\nend | psub ) $BUILDOZER -- -h\n'})})]})]}),"\n",(0,r.jsx)(t.h2,{id:"execroot-trick",children:"Execroot trick"}),"\n",(0,r.jsxs)(t.p,{children:["If the execution directory of the program does not matter\nyou can execute it directly from the ",(0,r.jsx)(t.em,{children:"execroot"}),",\nwhere all source files are available as they were during compilation in the sandbox.\nSo the debug symbol paths are correct.\nFirst build, then translate the ",(0,r.jsx)(t.code,{children:"bazel-bin"})," convenience symlink target\nto the real ",(0,r.jsx)(t.code,{children:"bazel-out"})," path\n(",(0,r.jsx)(t.code,{children:"bazel-bin"})," is not available in the ",(0,r.jsx)(t.em,{children:"execroot"}),")."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'$ bazel build -c dbg //buildozer\nTarget //buildozer:buildozer up-to-date:\n  bazel-bin/buildozer/buildozer_/buildozer\n$ cd bazel-buildtools\n$ dlv exec bazel-out/k8-dbg/bin/buildozer/buildozer_/buildozer -- -h\n(dlv) b main.main\nBreakpoint 1 set at 0x6e0a32 for main.main() buildozer/main.go:80\n(dlv) c\n main.main() buildozer/main.go:80 (hits goroutine(1):1 total:1) (PC: 0x6e0a32)\n ...\n=>  80: func main() {\n    81:         flag.Var(&commandsFiles, "f", "file name(s) to read commands from, use \'-\' for stdin (format:|-separated command line arguments to buildozer, excluding flags)")\n'})}),"\n",(0,r.jsxs)(t.p,{children:["No settings are needed for ",(0,r.jsx)(t.code,{children:"dlv"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["Finding the ",(0,r.jsx)(t.code,{children:"bazel-out"})," path is easy with ",(0,r.jsx)(t.code,{children:"readlink"}),".\nThis is the permanent output location,\nuntil you change the program or clean away all artifacts.\n",(0,r.jsx)(t.code,{children:"bazel-bin"})," is just the last build and is frequently rewritten."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"buildtools $ readlink bazel-bin\n.../9cc0cee4950d14fcd8254d5df1538d8e/execroot/buildtools/bazel-out/k8-dbg/bin\n"})}),"\n",(0,r.jsxs)(t.p,{children:["We need ",(0,r.jsx)(t.code,{children:"bazel-out/k8-dbg/bin"}),"."]})]})}function b(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},9365:(e,t,n)=>{n.d(t,{A:()=>l});n(6540);var r=n(8215);const o={tabItem:"tabItem_Ymn6"};var i=n(4848);function l(e){let{children:t,hidden:n,className:l}=e;return(0,i.jsx)("div",{role:"tabpanel",className:(0,r.A)(o.tabItem,l),hidden:n,children:t})}},1470:(e,t,n)=>{n.d(t,{A:()=>y});var r=n(6540),o=n(8215),i=n(3104),l=n(6347),s=n(205),a=n(7485),d=n(1682),c=n(679);function u(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??function(e){return u(e).map((e=>{let{props:{value:t,label:n,attributes:r,default:o}}=e;return{value:t,label:n,attributes:r,default:o}}))}(n);return function(e){const t=(0,d.XI)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function b(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function p(e){let{queryString:t=!1,groupId:n}=e;const o=(0,l.W6)(),i=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,a.aZ)(i),(0,r.useCallback)((e=>{if(!i)return;const t=new URLSearchParams(o.location.search);t.set(i,e),o.replace({...o.location,search:t.toString()})}),[i,o])]}function m(e){const{defaultValue:t,queryString:n=!1,groupId:o}=e,i=h(e),[l,a]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!b({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=n.find((e=>e.default))??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:i}))),[d,u]=p({queryString:n,groupId:o}),[m,g]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[o,i]=(0,c.Dv)(n);return[o,(0,r.useCallback)((e=>{n&&i.set(e)}),[n,i])]}({groupId:o}),f=(()=>{const e=d??m;return b({value:e,tabValues:i})?e:null})();(0,s.A)((()=>{f&&a(f)}),[f]);return{selectedValue:l,selectValue:(0,r.useCallback)((e=>{if(!b({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);a(e),u(e),g(e)}),[u,g,i]),tabValues:i}}var g=n(2303);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=n(4848);function j(e){let{className:t,block:n,selectedValue:r,selectValue:l,tabValues:s}=e;const a=[],{blockElementScrollPositionUntilNextRender:d}=(0,i.a_)(),c=e=>{const t=e.currentTarget,n=a.indexOf(t),o=s[n].value;o!==r&&(d(t),l(o))},u=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=a.indexOf(e.currentTarget)+1;t=a[n]??a[0];break}case"ArrowLeft":{const n=a.indexOf(e.currentTarget)-1;t=a[n]??a[a.length-1];break}}t?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":n},t),children:s.map((e=>{let{value:t,label:n,attributes:i}=e;return(0,x.jsx)("li",{role:"tab",tabIndex:r===t?0:-1,"aria-selected":r===t,ref:e=>a.push(e),onKeyDown:u,onClick:c,...i,className:(0,o.A)("tabs__item",f.tabItem,i?.className,{"tabs__item--active":r===t}),children:n??t},t)}))})}function v(e){let{lazy:t,children:n,selectedValue:i}=e;const l=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=l.find((e=>e.props.value===i));return e?(0,r.cloneElement)(e,{className:(0,o.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:l.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==i})))})}function z(e){const t=m(e);return(0,x.jsxs)("div",{className:(0,o.A)("tabs-container",f.tabList),children:[(0,x.jsx)(j,{...t,...e}),(0,x.jsx)(v,{...t,...e})]})}function y(e){const t=(0,g.A)();return(0,x.jsx)(z,{...e,children:u(e.children)},String(t))}},8453:(e,t,n)=>{n.d(t,{R:()=>l,x:()=>s});var r=n(6540);const o={},i=r.createContext(o);function l(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);