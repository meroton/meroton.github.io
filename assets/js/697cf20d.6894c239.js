"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2041],{6823:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var r=n(5893),s=n(1151);const o={slug:"bb-deployments-updates-2023-02",title:"Updates to Buildbarn deployment repo as of Febuary 2023",authors:"benjamin",tags:["release","buildbarn"]},a=void 0,i={permalink:"/blog/bb-deployments-updates-2023-02",editUrl:"https://github.com/meroton/docs/edit/main/blog/2023-02-21-updates-to-bb-deployments.mdx",source:"@site/blog/2023-02-21-updates-to-bb-deployments.mdx",title:"Updates to Buildbarn deployment repo as of Febuary 2023",description:"The example configuration project for buildbarn",date:"2023-02-21T00:00:00.000Z",formattedDate:"February 21, 2023",tags:[{label:"release",permalink:"/blog/tags/release"},{label:"buildbarn",permalink:"/blog/tags/buildbarn"}],readingTime:3.375,hasTruncateMarker:!1,authors:[{name:"Benjamin Ingberg",imageURL:"/img/benjamin-avatar.png",key:"benjamin"}],frontMatter:{slug:"bb-deployments-updates-2023-02",title:"Updates to Buildbarn deployment repo as of Febuary 2023",authors:"benjamin",tags:["release","buildbarn"]},unlisted:!1,prevItem:{title:"Buildbarn Block Sizes",permalink:"/blog/buildbarn-block-sizes"},nextItem:{title:"Bazel 6 Errors when using Build without the Bytes",permalink:"/blog/bazel-6-errors-build-without-the-bytes"}},l={authorsImageUrls:[void 0]},c=[{value:"Let ReferenceExpandingBlobAccess support GCS",id:"let-referenceexpandingblobaccess-support-gcs",level:2},{value:"Support for prefetching Virtual Filesystems",id:"support-for-prefetching-virtual-filesystems",level:2},{value:"Support for sha256tree",id:"support-for-sha256tree",level:2},{value:"Completeness checking now streams REv2 Tree objects",id:"completeness-checking-now-streams-rev2-tree-objects",level:2},{value:"Postponed healthy service status",id:"postponed-healthy-service-status",level:2},{value:"Server keepalive parameter options",id:"server-keepalive-parameter-options",level:2},{value:"Graceful termination of <code>LocalBlobAccess</code>",id:"graceful-termination-of-localblobaccess",level:2},{value:"Non-sector Aligned Writes to Block Device",id:"non-sector-aligned-writes-to-block-device",level:2},{value:"DAG Shaped BlobAccess Configuration",id:"dag-shaped-blobaccess-configuration",level:2},{value:"NFSv4 as worker filesystem",id:"nfsv4-as-worker-filesystem",level:2},{value:"Specify <code>forwardMetadata</code> with a JMESPath",id:"specify-forwardmetadata-with-a-jmespath",level:2},{value:"Tracing: Deprecate the Jaeger collector span exporter",id:"tracing-deprecate-the-jaeger-collector-span-exporter",level:2},{value:"<code>bb-deployments</code> Ubuntu 22.04 Example Runner Image",id:"bb-deployments-ubuntu-2204-example-runner-image",level:2},{value:"<code>bb-deployments</code> Integration Tests",id:"bb-deployments-integration-tests",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["The example configuration project for buildbarn\n",(0,r.jsx)(t.a,{href:"https://github.com/buildbarn/bb-deployments",children:"bb-deployments"}),"\nhas gotten updates."]}),"\n",(0,r.jsxs)(t.p,{children:["This is a continuation of the\n",(0,r.jsx)(t.a,{href:"/blog/bb-deploy-updates-2022-04",children:"updates from last year article"}),"\nand is a high level summary of what has happened since April 2022 up to 2023-02-16."]}),"\n",(0,r.jsx)(t.h2,{id:"let-referenceexpandingblobaccess-support-gcs",children:"Let ReferenceExpandingBlobAccess support GCS"}),"\n",(0,r.jsx)(t.p,{children:"ReferenceExpandingBlobAccess already supports S3 so support was extended to Google Cloud Storage buckets."}),"\n",(0,r.jsx)(t.h2,{id:"support-for-prefetching-virtual-filesystems",children:"Support for prefetching Virtual Filesystems"}),"\n",(0,r.jsx)(t.p,{children:"Running workers with Fuse allows inputs for an action\nto be downloaded on demand.\nThis significantly reduces the amount of data\nthat gets sent in order to run overspecified actions.\nThis however leads to poor performance for actions\nwhich reads a lot of their inputs synchronously."}),"\n",(0,r.jsx)(t.p,{children:"With the prefetcher most of these actions can be recognized\nand data which is likely to be needed\ncan be downloaded ahead of time."}),"\n",(0,r.jsx)(t.h2,{id:"support-for-sha256tree",children:"Support for sha256tree"}),"\n",(0,r.jsxs)(t.p,{children:["Buildbarn has added support for\n",(0,r.jsx)(t.a,{href:"https://github.com/bazelbuild/remote-apis/pull/235",children:"sha256tree"}),"\nwhich uses sha256 hashing over a tree structure similar to blake3."]}),"\n",(0,r.jsx)(t.p,{children:"This algorithm will allow large CAS objects to be chunked and decompositioned\nwith guaranteed data integrity while still using sha256 hardware instructions."}),"\n",(0,r.jsx)(t.h2,{id:"completeness-checking-now-streams-rev2-tree-objects",children:"Completeness checking now streams REv2 Tree objects"}),"\n",(0,r.jsx)(t.p,{children:"This change introduces a small change to the configuration schema. If you previous had this:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"backend: { completenessChecking: ... },\n"})}),"\n",(0,r.jsx)(t.p,{children:"You will now need to write something along these lines:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"backend: {\n    completenessChecking: {\n        backend: ...,\n        maximumTotalTreeSizeBytes: 64 * 1024 * 1024,\n    },\n},\n"})}),"\n",(0,r.jsxs)(t.p,{children:["See also the\n",(0,r.jsx)(t.a,{href:"https://github.com/buildbarn/bb-storage/commit/1b84fa824dc60e77776ce50e05c549fdf20c089b",children:"bb-storage commit 1b84fa8"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"postponed-healthy-service-status",children:"Postponed healthy service status"}),"\n",(0,r.jsxs)(t.p,{children:["The healthy and serving status,\ni.e. HTTP ",(0,r.jsx)(t.code,{children:"/-/healthy"})," and\n",(0,r.jsx)(t.a,{href:"https://pkg.go.dev/google.golang.org/grpc/health/grpc_health_v1#HealthCheckResponse_ServingStatus",children:"grpc_health_v1.HealthCheckResponse_SERVING"}),",\nare now postponed until the whole service is up and running.\nBefore, the healthy status was potentially reported before starting to listen to the gRPC ports.\nKubernetes will now wait until the service is up before forwarding connections to it."]}),"\n",(0,r.jsx)(t.h2,{id:"server-keepalive-parameter-options",children:"Server keepalive parameter options"}),"\n",(0,r.jsxs)(t.p,{children:["The option ",(0,r.jsx)(t.code,{children:"buildbarn.configuration.grpc.ServerConfiguration.keepalive_parameters"})," can be used for L4 load balancing,\nto control when to ask clients to reconnect.\nFor default values, see\n",(0,r.jsx)(t.a,{href:"https://pkg.go.dev/google.golang.org/grpc@v1.49.0/keepalive#ServerParameters",children:"keepalive.ServerParameters"}),"."]}),"\n",(0,r.jsxs)(t.h2,{id:"graceful-termination-of-localblobaccess",children:["Graceful termination of ",(0,r.jsx)(t.code,{children:"LocalBlobAccess"})]}),"\n",(0,r.jsxs)(t.p,{children:["When ",(0,r.jsx)(t.code,{children:"SIGTERM"})," or ",(0,r.jsx)(t.code,{children:"SIGINT"})," is received, the ",(0,r.jsx)(t.code,{children:"LocalBlobAccess"})," now synchronize data to disk before shutting down.\nDeployments using persistent storage will no longer observe loss of data when restarting the ",(0,r.jsx)(t.code,{children:"bb_storage"})," services."]}),"\n",(0,r.jsx)(t.h2,{id:"non-sector-aligned-writes-to-block-device",children:"Non-sector Aligned Writes to Block Device"}),"\n",(0,r.jsx)(t.p,{children:"Using sector aligned storage is wasteful for the action cache where the messages are typically very small.\nBuildbarn can now fill all the gaps when writing, making storage more efficient."}),"\n",(0,r.jsx)(t.h2,{id:"dag-shaped-blobaccess-configuration",children:"DAG Shaped BlobAccess Configuration"}),"\n",(0,r.jsxs)(t.p,{children:["Instead of a tree shaped BlobAccess configuration, the ",(0,r.jsx)(t.code,{children:"with_labels"})," notation allows a directed acyclic graph.\nSee also the\n",(0,r.jsx)(t.a,{href:"https://github.com/buildbarn/bb-storage/commit/cc295adc0f05cd579d48a65325ce54b54331c6a6",children:"bb-storage commit cc295ad"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"nfsv4-as-worker-filesystem",children:"NFSv4 as worker filesystem"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"bb_worker"})," can now supply the working directory for ",(0,r.jsx)(t.code,{children:"bb_runner"})," using NFSv4.\nPreviously, FUSE and hard linking files from the worker cache were the only two options.\nThis addition was mainly done to overcome the poor FUSE support on macOS."]}),"\n",(0,r.jsxs)(t.p,{children:["The NFSv4 server in ",(0,r.jsx)(t.code,{children:"bb_worker"})," only supports macOS at the moment.\nNo effort has been spent to write custom mount logic for other systems yet."]}),"\n",(0,r.jsxs)(t.h2,{id:"specify-forwardmetadata-with-a-jmespath",children:["Specify ",(0,r.jsx)(t.code,{children:"forwardMetadata"})," with a JMESPath"]}),"\n",(0,r.jsxs)(t.p,{children:["Metadata forwarding is now more flexible, the JMESPath expressions can for example add authorization result data.\nThe format is described in\n",(0,r.jsx)(t.a,{href:"https://github.com/buildbarn/bb-storage/blob/0c2fcad5872b0fef47bb5bee8aba9518dc2fe465/pkg/proto/configuration/grpc/grpc.proto#L55-L93",children:"grpc.proto"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"A common use case is to replace"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-jsonnet",children:'{\n    forwardMetadata: ["build.bazel.remote.execution.v2.requestmetadata-bin"],\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"with"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-jsonnet",children:'{\n    addMetadataJmespathExpression: \'{\n        "build.bazel.remote.execution.v2.requestmetadata-bin":\n            incomingGRPCMetadata."build.bazel.remote.execution.v2.requestmetadata-bin"\n    }\',\n}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"tracing-deprecate-the-jaeger-collector-span-exporter",children:"Tracing: Deprecate the Jaeger collector span exporter"}),"\n",(0,r.jsx)(t.p,{children:"This option is deprecated, as Jaeger 1.35 and later provide native support for the OpenTelemetry protocol."}),"\n",(0,r.jsxs)(t.h2,{id:"bb-deployments-ubuntu-2204-example-runner-image",children:[(0,r.jsx)(t.code,{children:"bb-deployments"})," Ubuntu 22.04 Example Runner Image"]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.a,{href:"https://github.com/bazelbuild/bazel-toolchains/blob/4.0.0/rules/rbe_repo.bzl#L896",children:"rbe_autoconfig"}),"\nin ",(0,r.jsx)(t.a,{href:"https://github.com/bazelbuild/bazel-toolchains",children:"bazel-toolchains"}),"\nhas been deprecated. In bb-deployments it has been replaced by the\n",(0,r.jsx)(t.a,{href:"https://github.com/nektos/act/blob/master/IMAGES.md",children:"Act"})," image\n",(0,r.jsxs)(t.a,{href:"https://github.com/catthehacker/docker_images",children:["ghcr.io/catthehacker/ubuntu",":act-22",".04"]}),",\ndistributed by ",(0,r.jsx)(t.a,{href:"https://github.com/catthehacker/docker_images",children:"catthehacker"}),",\nused for running GitHub Actions locally under Ubuntu 22.04."]}),"\n",(0,r.jsxs)(t.h2,{id:"bb-deployments-integration-tests",children:[(0,r.jsx)(t.code,{children:"bb-deployments"})," Integration Tests"]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.a,{href:"https://github.com/buildbarn/bb-deployments/tree/ce123473f27290648d1e56f7072468eb6b67fefb/bare",children:"bare deployment"})," and\n",(0,r.jsx)(t.a,{href:"https://github.com/buildbarn/bb-deployments/tree/ce123473f27290648d1e56f7072468eb6b67fefb/docker-compose",children:"Docker Compose deployment"}),"\nhave now got ",(0,r.jsx)(t.a,{href:"https://github.com/buildbarn/bb-deployments/tree/ce123473f27290648d1e56f7072468eb6b67fefb/tools",children:"tests scripts"}),"\nthat builds and tests ",(0,r.jsx)(t.code,{children:"@abseil-hello//:hello_test"})," remotely, shuts down and then checks for 100% cache hit after restart.\nAnother CI test is checking for minimal differences between the Docker Compose deployment and\nthe ",(0,r.jsx)(t.a,{href:"https://github.com/buildbarn/bb-deployments/tree/ce123473f27290648d1e56f7072468eb6b67fefb/kubernetes",children:"Kubernetes deployment"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"If there are any other changes you feel deserve a mention\nfeel free to submit a pull request at github using the link below."})]})}function h(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>i,a:()=>a});var r=n(7294);const s={},o=r.createContext(s);function a(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);