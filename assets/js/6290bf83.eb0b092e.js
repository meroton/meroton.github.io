"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5755],{3830:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>h,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"improved-chroot-in-buildbarn/the-problem-with-special-filesystems","title":"II The Problem with Special Mounts","description":"The [fuse and chroot setup]","source":"@site/docs/improved-chroot-in-buildbarn/the-problem-with-special-filesystems.md","sourceDirName":"improved-chroot-in-buildbarn","slug":"/improved-chroot-in-buildbarn/the-problem-with-special-filesystems","permalink":"/docs/improved-chroot-in-buildbarn/the-problem-with-special-filesystems","draft":false,"unlisted":false,"editUrl":"https://github.com/meroton/docs/edit/main/docs/improved-chroot-in-buildbarn/the-problem-with-special-filesystems.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"II The Problem with Special Mounts","sidebar_position":2},"sidebar":"sidebar","previous":{"title":"I Chroot in Buildbarn","permalink":"/docs/improved-chroot-in-buildbarn/chroot-in-buildbarn"},"next":{"title":"III Implementing Mountat","permalink":"/docs/improved-chroot-in-buildbarn/implementing-mountat"}}');var o=n(4848),s=n(8453);const r={title:"II The Problem with Special Mounts",sidebar_position:2},h="The problem with special mounts",c={},l=[{value:"Mounting the special filesystems in the worker?",id:"mounting-the-special-filesystems-in-the-worker",level:2},{value:"Mounting the special filesystems in the runner",id:"mounting-the-special-filesystems-in-the-runner",level:2},{value:"The search for &quot;mountat&quot;",id:"the-search-for-mountat",level:2}];function a(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",p:"p",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"the-problem-with-special-mounts",children:"The problem with special mounts"})}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsxs)(t.a,{href:"/docs/improved-chroot-in-buildbarn/chroot-in-buildbarn/",children:[(0,o.jsx)(t.code,{children:"fuse"})," and ",(0,o.jsx)(t.code,{children:"chroot"})," setup"]}),"\nworks well for many tools, but not all."]}),"\n",(0,o.jsxs)(t.p,{children:["Some tools rely on the ",(0,o.jsx)(t.code,{children:"/proc"})," filesystem to operate.\nThe best example is ",(0,o.jsx)(t.code,{children:"cargo"})," and ",(0,o.jsx)(t.code,{children:"rustc"})," that fails with the following message:"]}),"\n",(0,o.jsx)(t.p,{children:"Thread 'main' panicked at 'failed to get current_exe:\nno /proc/self/exe available. Is /proc mounted?"}),"\n",(0,o.jsxs)(t.p,{children:["The goal of this series is to ",(0,o.jsx)(t.a,{href:"/docs/improved-chroot-in-buildbarn/implementing-mountat/",children:"solve this"}),",\nso you never have to worry about the problem stated here."]}),"\n",(0,o.jsxs)(t.p,{children:["There are also problems with ",(0,o.jsx)(t.code,{children:"go"}),", ",(0,o.jsx)(t.code,{children:"node"}),", ",(0,o.jsx)(t.code,{children:"javac"})," that have been observed in the ",(0,o.jsx)(t.a,{href:"https://github.com/buildbarn/bb-deployments/",children:"bb-deployments"})," repo.\nJust like ",(0,o.jsx)(t.code,{children:"rustc"}),", the ",(0,o.jsx)(t.code,{children:"go"})," compiler tries to find itself through ",(0,o.jsx)(t.code,{children:"/proc/self/exe"}),"\nand find the ",(0,o.jsx)(t.code,{children:"GOROOT"})," based on that path.\nWe have used ",(0,o.jsx)(t.a,{href:"https://github.com/buildbarn/bb-deployments/",children:"bb-deployments"})," as the development repo\nwhen diagnosing this problem and developing patches,\nit can be built successfully when the filesystems are mounted."]}),"\n",(0,o.jsx)(t.h2,{id:"mounting-the-special-filesystems-in-the-worker",children:"Mounting the special filesystems in the worker?"}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsx)(t.em,{children:"action"})," is prepared in the ",(0,o.jsx)(t.em,{children:"worker"}),",\nthe core is the ",(0,o.jsx)(t.a,{href:"https://github.com/buildbarn/bb-remote-execution/blob/96c4fdce659fabfaba7ee2a60fd4e2ffab8352e2/pkg/builder/local_build_executor.go",children:"local build executor"})," where ",(0,o.jsx)(t.a,{href:"https://github.com/buildbarn/bb-remote-execution/blob/96c4fdce659fabfaba7ee2a60fd4e2ffab8352e2/pkg/builder/local_build_executor.go#L111",children:"Execute"})," executes an ",(0,o.jsx)(t.em,{children:"action"}),".\nIt creates sandbox directory with all the input files,\nthrough a virtual directory abstraction,\nso the files can be loaded lazily through ",(0,o.jsx)(t.code,{children:"fuse"}),".\nThe ",(0,o.jsx)(t.em,{children:"worker"})," also ",(0,o.jsx)(t.a,{href:"https://github.com/buildbarn/bb-remote-execution/blob/96c4fdce659fabfaba7ee2a60fd4e2ffab8352e2/pkg/builder/local_build_executor.go#L185",children:"creates the special character devices"}),".\nThese are needed for ",(0,o.jsx)(t.code,{children:"chroot"})," actions can use ",(0,o.jsx)(t.code,{children:"/dev/null"}),", ",(0,o.jsx)(t.code,{children:"/dev/full"})," et cetera."]}),"\n",(0,o.jsxs)(t.p,{children:["Though ",(0,o.jsx)(t.code,{children:"chroot"})," configuration is done in the ",(0,o.jsx)(t.em,{children:"runner"}),",\nwhich prepares and executes the ",(0,o.jsx)(t.em,{children:"action"})," process described by the ",(0,o.jsx)(t.em,{children:"worker"}),".\nThis indicates that we should keep the configuration of the filesystems in the ",(0,o.jsx)(t.em,{children:"runner"}),".\nCombined with the ",(0,o.jsx)(t.em,{children:"worker"}),"'s virtual filesystem,\nwhere the directories can be purely virtual\nwe have nothing to pin mounts on in the ",(0,o.jsx)(t.em,{children:"worker"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"mounting-the-special-filesystems-in-the-runner",children:"Mounting the special filesystems in the runner"}),"\n",(0,o.jsxs)(t.p,{children:["We want to mount the filesystems in the ",(0,o.jsx)(t.em,{children:"runner"}),"\nwhich has a ",(0,o.jsxs)(t.a,{href:"https://github.com/buildbarn/bb-storage/blob/master/pkg/filesystem/directory.go",children:["local ",(0,o.jsx)(t.code,{children:"Directory"})]}),",\njust with the limitation that we should not use filepaths.\nWe want to use the ",(0,o.jsx)(t.code,{children:"at"}),"-family of syscalls.\nThis is not technically a requirement,\nas we can construct absolute file paths here,\nbut we value compartmentalization that the ",(0,o.jsx)(t.code,{children:"at"}),"-syscalls give us.\nWe know that code for one action can not address paths outside its input root."]}),"\n",(0,o.jsx)(t.h2,{id:"the-search-for-mountat",children:'The search for "mountat"'}),"\n",(0,o.jsxs)(t.p,{children:['This led to a search for the missing "mountat" syscall,\nwhich can be ',(0,o.jsx)(t.a,{href:"/docs/improved-chroot-in-buildbarn/implementing-mountat/",children:"implemented with the new Linux mount API"}),",\nand a lot of consternation in ",(0,o.jsx)(t.a,{href:"/docs/improved-chroot-in-buildbarn/implementing-unmountat/",children:"trying to implement unmountat"})," with the same API."]}),"\n",(0,o.jsxs)(t.p,{children:["The path to better mounting in ",(0,o.jsx)(t.code,{children:"bb-remote-execution"})," is ",(0,o.jsx)(t.a,{href:"https://github.com/buildbarn/bb-remote-execution/issues/115",children:"tracked here"}),".\nThis series aims to document the details and a solution.\nPatches that you can apply are ",(0,o.jsx)(t.a,{href:"/docs/improved-chroot-in-buildbarn/integrating-mountat/",children:"listed here"}),",\nas well as discussion about merging them into ",(0,o.jsx)(t.code,{children:"Buildbarn"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["Note that the special character devices that are already in use are not actually mounted,\nand can be created in the virtual layer.\nWhich is why they are not handled in the ",(0,o.jsx)(t.em,{children:"runner"}),",\nand the ",(0,o.jsx)(t.code,{children:"chroot"})," configuration is split between the worker and the runner,"]})]})}function d(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>h});var i=n(6540);const o={},s=i.createContext(o);function r(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function h(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:t},e.children)}}}]);