<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-improved-chroot-in-buildbarn/implementing-unmountat" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">IV Trying to Implement Unmountat | Meroton</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://meroton.github.io/docs/improved-chroot-in-buildbarn/implementing-unmountat/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="IV Trying to Implement Unmountat | Meroton"><meta data-rh="true" name="description" content="This continues from [implementing mountat with the new Linux mount API]"><meta data-rh="true" property="og:description" content="This continues from [implementing mountat with the new Linux mount API]"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://meroton.github.io/docs/improved-chroot-in-buildbarn/implementing-unmountat/"><link data-rh="true" rel="alternate" href="https://meroton.github.io/docs/improved-chroot-in-buildbarn/implementing-unmountat/" hreflang="en"><link data-rh="true" rel="alternate" href="https://meroton.github.io/docs/improved-chroot-in-buildbarn/implementing-unmountat/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title=" RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title=" Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title=" JSON Feed">



<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LVF8V72WEQ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-LVF8V72WEQ",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.08bb7386.css">
<script src="/assets/js/runtime~main.1a193b46.js" defer="defer"></script>
<script src="/assets/js/main.53b905c6.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Meroton" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Meroton" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Meroton</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro/">Documentation</a><a class="navbar__item navbar__link" href="/services/">Services</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://forms.gle/wchwDu6roWg6A7U29" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Sign up<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/theory/components-of-a-build/">Theory</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/practice/rebase-and-reformat-git-branches-automatically/">Practice</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/tips/">Tips and Tricks</a><button aria-label="Expand sidebar category &#x27;Tips and Tricks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/improved-chroot-in-buildbarn/">Improved chroot in Buildbarn</a><button aria-label="Collapse sidebar category &#x27;Improved chroot in Buildbarn&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/improved-chroot-in-buildbarn/chroot-in-buildbarn/">I Chroot in Buildbarn</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/improved-chroot-in-buildbarn/the-problem-with-special-filesystems/">II The Problem with Special Mounts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/improved-chroot-in-buildbarn/implementing-mountat/">III Implementing Mountat</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/improved-chroot-in-buildbarn/implementing-unmountat/">IV Trying to Implement Unmountat</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/improved-chroot-in-buildbarn/integrating-mountat/">V Integrating Mountat in Buildbarn</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/improved-chroot-in-buildbarn/reproducing-the-problem/">VI Reproducing the Problem</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/improved-chroot-in-buildbarn/"><span itemprop="name">Improved chroot in Buildbarn</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">IV Trying to Implement Unmountat</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Try to create &quot;unmountat&quot; with the new Linux mount API</h1>
<p>This continues from <a href="/docs/improved-chroot-in-Buildbarn/implementing-mountat/">implementing mountat with the new Linux mount API</a>
in an effort to improve <a href="/docs/improved-chroot-in-Buildbarn/">chroot in Buildbarn</a>
and mount the <code>/proc</code> and <code>/sys</code> filesystem in the input root for <code>REAPI</code> <em>actions</em>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-new-mount-api">The new mount API<a href="#the-new-mount-api" class="hash-link" aria-label="Direct link to The new mount API" title="Direct link to The new mount API">​</a></h2>
<p>A short summary, see <a href="/docs/improved-chroot-in-Buildbarn/implementing-mountat/">implementing mountat</a> for more background.</p>
<p>David Howells at Redhat the &quot;new mount API&quot; with several new syscalls
primarily used to speed up work with namespaces and moving mounts back and forth.
The benefit (for us) is that it allows relative paths.</p>
<p>Announcement:</p>
<blockquote>
<p>Six (or seven) new system calls for filesystem mounting
<a href="https://lwn.net/Articles/759499/" target="_blank" rel="noopener noreferrer">https://lwn.net/Articles/759499/</a></p>
</blockquote>
<p>Note that this is not the final API but describes the background well.
The <code>write</code> call will not be used at all.
Later patch sets and the man pages explain the API better,
but some vagaries remain as we will see later.</p>
<p>Man pages:</p>
<blockquote>
<p>Add manpage for fsopen(2), fspick(2) and fsmount(2)
<a href="https://lwn.net/Articles/802096/" target="_blank" rel="noopener noreferrer">https://lwn.net/Articles/802096/</a></p>
</blockquote>
<blockquote>
<p>[MANPAGE PATCH] Add manpages for move_mount(2) and open_tree(2)
<a href="https://lore.kernel.org/linux-man/15488.1531263249@warthog.procyon.org.uk/t/" target="_blank" rel="noopener noreferrer">https://lore.kernel.org/linux-man/15488.1531263249@warthog.procyon.org.uk/t/</a></p>
</blockquote>
<p>Commit information:</p>
<blockquote>
<p>vfs: syscall: Add fsconfig() for configuring and managing a context · torvalds/linux@ecdab15
<a href="https://github.com/torvalds/linux/commit/ecdab150fddb42fe6a739335257949220033b782" target="_blank" rel="noopener noreferrer">https://github.com/torvalds/linux/commit/ecdab150fddb42fe6a739335257949220033b782</a></p>
</blockquote>
<p>Unfortunately I have not found the official man pages anywhere.
So the risk of this article being out-of-date is looming.
Just as the announcement gave examples with <code>write</code> that does not work with the real code.</p>
<p>Quote the manpages:</p>
<p>move_mount () call moves a mount from one place to another;
it can also be used to attach an
unattached mount created by
fsmount() or open_tree() with OPEN_TREE_CLONE .</p>
<p>move_mount () is called repeatedly with a file descriptor that refers to a mount object,
then the object will be attached/moved the first time and then moved again and
again and again, detaching it from the previous mountpoint each time.</p>
<p>This is where we start to implement &quot;unmountat&quot;,
the idea is to</p>
<p>A1: pick up the mount from the directory
A2: delete the mount</p>
<p>B1: pick up the mount from the directory
B2: move it somewhere else
B3: unmount it from there</p>
<p>C1: emulate <code>umountat</code> with <code>fchdir</code> + <code>umount</code></p>
<p>The first is what we would like to do, but it does not work.
The second is a half-measure that allows us to use a well-known absolute path
and use an &quot;Indiana-Jones swap&quot; technique
before unmounting the absolute path with good-old <code>unmount</code>.
But that does not work either.
So we use the third idea,
which does not use the new API at all.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="move-mount">Move mount<a href="#move-mount" class="hash-link" aria-label="Direct link to Move mount" title="Direct link to Move mount">​</a></h2>
<p>We try the given examples:</p>
<p>EXAMPLES
The move_mount ()function can be used like the following:</p>
<p>move_mount(AT_FDCWD, &quot;/a&quot;, AT_FDCWD, &quot;/b&quot;, 0);</p>
<p>This would move the object mounted on &quot;/a&quot; to &quot;/b&quot;.  It can also be used in
conjunction with open_tree(2) open(2) with O_PATH :</p>
<p>fd = open_tree(AT_FDCWD, &quot;/mnt&quot;, 0);
move_mount(fd, &quot;&quot;, AT_FDCWD, &quot;/mnt2&quot;, MOVE_MOUNT_F_EMPTY_PATH);
move_mount(fd, &quot;&quot;, AT_FDCWD, &quot;/mnt3&quot;, MOVE_MOUNT_F_EMPTY_PATH);
move_mount(fd, &quot;&quot;, AT_FDCWD, &quot;/mnt4&quot;, MOVE_MOUNT_F_EMPTY_PATH);</p>
<p>This would attach the path point for &quot;/mnt&quot; to fd, then it would move the
mount to &quot;/mnt2&quot;, then move it to &quot;/mnt3&quot; and finally to &quot;/mnt4&quot;.</p>
<p>We know that <code>move_mount</code> can be used to place a <em>mount object</em> on a mount point,
that is how <a href="https://github.com/meroton/prototype-mountat/blob/main/c-prototypes/mountat_dfd.c#L52" target="_blank" rel="noopener noreferrer">mountat</a> is implemented, here is <a href="https://github.com/torvalds/linux/blob/89bf6209cad66214d3774dac86b6bbf2aec6a30d/samples/vfs/test-fsmount.c#L103" target="_blank" rel="noopener noreferrer">official reference code</a>.</p>
<p>But these examples do not seem to work.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Move from a source directory file descriptor `s_dfd`</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * to the destination `d_dfd`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Try to use &#x27;move_mount&#x27; directly on the mount point.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">move_mount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//     strace: move_mount(3, &quot;proc&quot;, 6, &quot;proc&quot;, 0)     = -1 EINVAL (Invalid argument)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Try to use &#x27;move_mount&#x27; on the mount file descriptor from `fspick`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Pick up, a so called, &quot;filesystem configuration context&quot;.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> cfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fspick</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FSPICK_NO_AUTOMOUNT </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> FSPICK_CLOEXEC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">move_mount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//     strace: move_mount(7, &quot;&quot;, 6, &quot;proc&quot;, 0)         = -1 ENOENT (No such file or directory)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">move_mount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MOVE_MOUNT_F_EMPTY_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//     strace: move_mount(7, &quot;&quot;, 6, &quot;proc&quot;, MOVE_MOUNT_F_EMPTY_PATH) = -1 EINVAL (Invalid argument)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Must we create a mount again?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// So `fspick` is equivalent to `fsopen`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Additionally, the manpage says that we must reconfigure it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">fsconfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FSCONFIG_CMD_RECONFIGURE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> mfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fsmount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FSMOUNT_CLOEXEC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MS_NOEXEC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//     strace: fsmount(5, FSMOUNT_CLOEXEC, MOUNT_ATTR_NOEXEC) = -1 EBUSY (Device or resource busy)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// But `fsmount` fails, so this does not seem to be it.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Either way I try I get <code>EINVAL</code></p>
<p>.EINVAL
Reserved flag specified in flags .</p>
<p>Which is not described very well.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pick-up-the-mount">Pick up the mount<a href="#pick-up-the-mount" class="hash-link" aria-label="Direct link to Pick up the mount" title="Direct link to Pick up the mount">​</a></h2>
<p>With <code>open_tree</code>:</p>
<p>open_tree () picks the mount object specified by the pathname and attaches it to a new file
descriptor or clones it and attaches the clone to the file descriptor.  The
resultant file descriptor is indistinguishable from one produced by
open(2) with O_PATH .</p>
<p>In the case that the mount object is cloned, the clone will be &quot;unmounted&quot; and
destroyed when the file descriptor is closed if it is not otherwise mounted
somewhere by calling move_mount (2).</p>
<p>Just like the example above, this can be read as allowing an unmount through <code>move_mount</code>.
Though the primary use case is to clone a mount and move that.
Do we need <code>fsmount</code> in the way?</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// And using `open_tree` gives failures for `fsconfig` directly.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> mmmfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open_tree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">fsconfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mmmfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FSCONFIG_CMD_RECONFIGURE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//     strace: fsconfig(5, FSCONFIG_CMD_RECONFIGURE, NULL, NULL, 0) = -1 EBADF (Bad file descriptor)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Try to use &#x27;move_mount&#x27; on the tree file descriptor from &#x27;open_tree&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> mmfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open_tree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">move_mount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mmfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MOVE_MOUNT_F_EMPTY_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//    strace: move_mount(8, &quot;&quot;, 6, &quot;proc&quot;, MOVE_MOUNT_F_EMPTY_PATH) = -1 EINVAL (Invalid argument)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So we should not attempt to configure the mount file descriptor from <code>fsconfig</code>,
But we can not move it either.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="einval">EINVAL<a href="#einval" class="hash-link" aria-label="Direct link to EINVAL" title="Direct link to EINVAL">​</a></h2>
<p>We are stumped by this message,
the next step would be to dig into the <a href="https://github.com/torvalds/linux/blob/master/fs/namespace.c#L4058" target="_blank" rel="noopener noreferrer">source code</a>,
<a href="https://docs.kernel.org/dev-tools/gdb-kernel-debugging.html" target="_blank" rel="noopener noreferrer">debug the kernel code in a VM</a>,
or see if the file descriptors give more information.</p>
<p>From the older documentation of <code>fsopen</code>, there are some hints to how to find more information.
But we suspect that this is out-of-date,
as the same version of the documentation wrote commands into the file descriptors,
which is not how the merged code works.
So this is quoted with some skepticism,
but serves as a starting point to continue troubleshooting this.</p>
<p>Message Retrieval Interface</p>
<p>The context file descriptor may be queried for message strings at any time by
calling read(2) on the file descriptor.
This will return formatted messages that are prefixed
to indicate their class:</p>
<p>&quot;e &lt;message&gt;&quot;
An error message string was logged.</p>
<p>&quot;i &lt;message&gt;&quot;
An informational message string was logged.</p>
<p>&quot;w &lt;message&gt;&quot;
An warning message string was logged.</p>
<p>Messages are removed from the queue as they&#x27;re read.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="copy-mount">Copy mount<a href="#copy-mount" class="hash-link" aria-label="Direct link to Copy mount" title="Direct link to Copy mount">​</a></h2>
<p>The only things that work with the new API is to clone the mount,
and then move the clone.
So we copy the mount, but leave the original in-place.
That is not a workable solution for us.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// We can successfully move a clone, but not the original mount it seems.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> mmmfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open_tree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OPEN_TREE_CLONE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">move_mount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mmmfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d_dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mountpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MOVE_MOUNT_F_EMPTY_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-investigation">Further investigation<a href="#further-investigation" class="hash-link" aria-label="Direct link to Further investigation" title="Direct link to Further investigation">​</a></h2>
<p>Google does not help in finding many uses cases,
but there are a few emails with newer dates:</p>
<ul>
<li><a href="https://lore.kernel.org/linux-man/159827188271.306468.16962617119460123110.stgit@warthog.procyon.org.uk/" target="_blank" rel="noopener noreferrer">open_tree</a></li>
<li><a href="https://lore.kernel.org/linux-man/159827189025.306468.4916341547843731338.stgit@warthog.procyon.org.uk/" target="_blank" rel="noopener noreferrer">move_mount</a></li>
</ul>
<p>But they have the same examples</p>
<p>There is also the <code>lxc</code> project, which has the most code that use the new API.
But they do not use an &quot;unmountat&quot; function.</p>
<ul>
<li><a href="https://github.com/lxc/lxc/blob/main/src/lxc/mount_utils.c#L291" target="_blank" rel="noopener noreferrer">create detached mount</a></li>
<li><a href="https://github.com/lxc/lxc/blob/main/src/lxc/mount_utils.c#L613" target="_blank" rel="noopener noreferrer">mount_at</a></li>
</ul>
<p>There is also the <a href="https://github.com/shiziwen/linux/blob/26b0332e30c7f93e780aaa054bd84e3437f84354/fs/namei.c#L2305" target="_blank" rel="noopener noreferrer">path_unmountat</a> function in the kernel,
but to my reading this is part of the filesystem subsystem,
and not plumbed through to a syscall for regular mounts.</p>
<p>This is another interesting use case: <a href="https://github.com/kinvolk/nfs-mount-in-userns" target="_blank" rel="noopener noreferrer">NFS-mount-in-user-namespace</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="acceptable-solution-relative-unmount">Acceptable solution: relative unmount<a href="#acceptable-solution-relative-unmount" class="hash-link" aria-label="Direct link to Acceptable solution: relative unmount" title="Direct link to Acceptable solution: relative unmount">​</a></h2>
<p>To leave this in a some what positive note,
we can use a relative <code>unmount</code> like this relative mount example from <a href="https://github.com/torvalds/linux/blob/93f5de5f648d2b1ce3540a4ac71756d4a852dc23/tools/testing/selftests/openat2/resolve_test.c#L75" target="_blank" rel="noopener noreferrer">Linux&#x27;s test</a>.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* There is no mountat(2), so use chdir. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">E_mkdirat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mnt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0755</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">E_fchdir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dfd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">E_mount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tmpfs&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./mnt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;tmpfs&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MS_NOSUID </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MS_NODEV</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This relative mount technique is acceptable for Buildbarn.
During the process to patch this,
we realized that <a href="https://github.com/buildbarn/bb-storage/blob/ece87ab6dc2a9e1e592d2032f5a02c3694765cfc/pkg/filesystem/local_directory_unix.go#L271" target="_blank" rel="noopener noreferrer">Buildbarn already did this</a>, :).
Simple c-code is <a href="https://github.com/meroton/prototype-mountat/blob/main/c-prototypes/relative_mount.c" target="_blank" rel="noopener noreferrer">available here</a> with <a href="https://github.com/meroton/prototype-mountat/blob/cmd/relative-unmount/main.go" target="_blank" rel="noopener noreferrer">similar go code here</a>.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> mountpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./proc&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> initial </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> dfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">openat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AT_FDCWD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> initial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fchdir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dfd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">umount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mountpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="request-of-the-audience">Request of the audience<a href="#request-of-the-audience" class="hash-link" aria-label="Direct link to Request of the audience" title="Direct link to Request of the audience">​</a></h2>
<p>Do you know how to use the new mount API to implement <code>unmountat</code>?
Do you spot any errors in our investigation, or ideas we forgot?
Please let us know!</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/meroton/docs/edit/main/docs/improved-chroot-in-buildbarn/implementing-unmountat.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/improved-chroot-in-buildbarn/implementing-mountat/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">III Implementing Mountat</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/improved-chroot-in-buildbarn/integrating-mountat/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">V Integrating Mountat in Buildbarn</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-new-mount-api" class="table-of-contents__link toc-highlight">The new mount API</a></li><li><a href="#move-mount" class="table-of-contents__link toc-highlight">Move mount</a></li><li><a href="#pick-up-the-mount" class="table-of-contents__link toc-highlight">Pick up the mount</a></li><li><a href="#einval" class="table-of-contents__link toc-highlight">EINVAL</a></li><li><a href="#copy-mount" class="table-of-contents__link toc-highlight">Copy mount</a></li><li><a href="#further-investigation" class="table-of-contents__link toc-highlight">Further investigation</a></li><li><a href="#acceptable-solution-relative-unmount" class="table-of-contents__link toc-highlight">Acceptable solution: relative unmount</a></li><li><a href="#request-of-the-audience" class="table-of-contents__link toc-highlight">Request of the audience</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/theory/components-of-a-build/">Theory</a></li></ul></div><div class="col footer__col"><div class="footer__title">About Us</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/services/">Services</a></li><li class="footer__item"><a class="footer__link-item" href="/contact/">Contact</a></li><li class="footer__item"><a href="https://forms.gle/wchwDu6roWg6A7U29" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sign up<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Hosted build system</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/services/self-hosted/">Self hosted</a></li><li class="footer__item"><a class="footer__link-item" href="/services/cloud-environment/">Cloud based</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/bug-bounty/">Bug bounty</a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy/">Privacy Policy</a></li><li class="footer__item"><a href="https://github.com/meroton" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Meroton AB</div></div></div></footer></div>
</body>
</html>