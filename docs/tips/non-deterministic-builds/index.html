<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title=" RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title=" Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title=" JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LVF8V72WEQ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-LVF8V72WEQ",{anonymize_ip:!0})</script><title data-react-helmet="true">Non-deterministic Builds | Meroton</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://meroton.github.io/docs/tips/non-deterministic-builds/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Non-deterministic Builds | Meroton"><meta data-react-helmet="true" name="description" content="Builds should be deterministic, if the inputs are unchanged they should produce the same output. In Bazel terminology this is often refered to as builds being hermetic, i.e. fully self enclosed with regards to its inputs."><meta data-react-helmet="true" property="og:description" content="Builds should be deterministic, if the inputs are unchanged they should produce the same output. In Bazel terminology this is often refered to as builds being hermetic, i.e. fully self enclosed with regards to its inputs."><link data-react-helmet="true" rel="icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://meroton.github.io/docs/tips/non-deterministic-builds/"><link data-react-helmet="true" rel="alternate" href="https://meroton.github.io/docs/tips/non-deterministic-builds/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://meroton.github.io/docs/tips/non-deterministic-builds/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c319aca5.css">
<link rel="preload" href="/assets/js/runtime~main.8d674480.js" as="script">
<link rel="preload" href="/assets/js/main.956d3e02.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Meroton" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="Meroton" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Meroton</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro/">Documentation</a><a class="navbar__item navbar__link" href="/services/">Services</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://forms.gle/wchwDu6roWg6A7U29" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Sign up<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/theory/components-of-a-build/">Theory</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/docs/tips/">Tips and Tricks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tips and Tricks&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/tips/non-deterministic-builds/">Non-deterministic Builds</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Non-deterministic Builds</h1><p>Builds should be deterministic, if the inputs are unchanged they should produce the same output. In Bazel terminology this is often refered to as builds being hermetic, i.e. fully self enclosed with regards to its inputs.</p><p>This is sometimes not the case, and in those instances your system might produce different artifacts when run with the same inputs.</p><p>There are several reasons why this could happen</p><ul><li>An unspecified input that has been changed</li><li>A result which is based on random chance or statistical behavior</li><li>Timestamps or a wall time dependency</li></ul><p>Different reasons will have different methods of resolution. It is in general an error for a build to produce different results with the same input, however, the most common consequence of this error is a build performance penalty.</p><p>If you can&#x27;t fully eliminate non-determinism in your builds you should strive to avoid it and make sure that the consequence are only minor build performance detriments.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="automatic-detection-of-non-deterministic-actions">Automatic Detection of Non-Deterministic Actions<a class="hash-link" href="#automatic-detection-of-non-deterministic-actions" title="Direct link to heading">â€‹</a></h2><p>By rerunning a small subset of your actions and checking the output the build system can detect non-determinism. We rerun the actions with a small delay to automatically detect if that action would result in different outputs.</p><p>This is not guaranteed to catch every instance of non-determinism, but is a great filter for most of them.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="sample-rate">Sample Rate<a class="hash-link" href="#sample-rate" title="Direct link to heading">â€‹</a></h2><p>Sample Rate determines the fraction of actions that will be rerun. The default value is 0 (off) which won&#x27;t generate any reports. The recommended value is 1% but it can be set up to 100% (rerun all actions).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="timestamped-outputs">Timestamped Outputs<a class="hash-link" href="#timestamped-outputs" title="Direct link to heading">â€‹</a></h2><p>One common reason for non-determinism is timestamped outputs. Some part of the build process adds the current wall time to the output.</p><p>Common fixes for this problem is to either set the date/time value to something predictable like the current commit time or a redacted value</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gcc input.c -Wno-builtin-macro-redefined -D__TIME__=&quot;REDACTED&quot; -D__DATE__=&quot;REDACTED&quot; -D__TIMESTAMP__=&quot;REDACTED&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The exact method will depend on your build tool.</p><p>The periodicity of the timestamp might vary. In order to be able to timestamps which are not very granular the rerun actions are by default run with a 60 second delay. This allows us to detect timestamps with an <code>HH:mm</code> format.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="do-not-rerun-expensive-actions">Do not Rerun Expensive Actions<a class="hash-link" href="#do-not-rerun-expensive-actions" title="Direct link to heading">â€‹</a></h2><p>By default we only rerun actions which were completed within 10 seconds, this allows us to avoid rerunning very expensive actions. In most builds the vast majority of actions are completed in a fraction of a second.</p><p>This value can be modified or unset in order to allow any action to be rerun. NOTE: If the action takes longer than the rerun delay they will be scheduled after the action has been completed.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="actions-with-inherently-random-output">Actions with Inherently Random Output<a class="hash-link" href="#actions-with-inherently-random-output" title="Direct link to heading">â€‹</a></h2><p>Some actions can by design have random output. If possible we recommend to seed the RNG with a known random value which is supplied as an input. Doing this tells bazel not to expect different runs with different seeds to have the same output.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/meroton/docs/edit/main/docs/tips/non-deterministic-builds.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/tips/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Tips and Tricks</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#automatic-detection-of-non-deterministic-actions" class="table-of-contents__link toc-highlight">Automatic Detection of Non-Deterministic Actions</a></li><li><a href="#sample-rate" class="table-of-contents__link toc-highlight">Sample Rate</a></li><li><a href="#timestamped-outputs" class="table-of-contents__link toc-highlight">Timestamped Outputs</a></li><li><a href="#do-not-rerun-expensive-actions" class="table-of-contents__link toc-highlight">Do not Rerun Expensive Actions</a></li><li><a href="#actions-with-inherently-random-output" class="table-of-contents__link toc-highlight">Actions with Inherently Random Output</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/theory/components-of-a-build/">Theory</a></li></ul></div><div class="col footer__col"><div class="footer__title">About Us</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/services/">Services</a></li><li class="footer__item"><a class="footer__link-item" href="/contact/">Contact</a></li><li class="footer__item"><a href="https://forms.gle/wchwDu6roWg6A7U29" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Sign up<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Hosted build system</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/services/self-hosted/">Self hosted</a></li><li class="footer__item"><a class="footer__link-item" href="/services/cloud-environment/">Cloud based</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/meroton" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Meroton AB</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8d674480.js"></script>
<script src="/assets/js/main.956d3e02.js"></script>
</body>
</html>