{
    "version": "https://jsonfeed.org/version/1",
    "title": "",
    "home_page_url": "https://meroton.github.io/blog/",
    "items": [
        {
            "id": "https://meroton.github.io/blog/understanding-the-klm/",
            "content_html": "<p>When running a remote cache and execution cluster based on Buildbarn the Key\nLocation Map (KLM) is a term that you will run into and it is important to take\nproper care when sizing the KLM and the number of KLM attempts.</p>\n<p>If you are just looking for a ballpark number to get you started, set the\nnumber of get attempts to 16 and the number of put attempts to 64 and use the\nfollowing table.</p>\n<table><thead><tr><th></th><th>CAS</th><th>AC</th></tr></thead><tbody><tr><td>Average Object Size</td><td>500KB</td><td>1KB</td></tr><tr><td>Storage Size</td><td>1TB</td><td>1GB</td></tr><tr><td>KLM Entries</td><td>8 000 000</td><td>4 000 000</td></tr><tr><td>KLM Size</td><td>528MB</td><td>264MB</td></tr></tbody></table>\n<p>I recommend reading the rest of the article to understand what you are actually\nsetting and how to reason about this.</p>\n<h1>How does the KLM work?</h1>\n<p>The KLM is a <a href=\"https://en.wikipedia.org/wiki/Hash_table\" target=\"_blank\" rel=\"noopener noreferrer\">hash table</a> which\ndescribes the position in your storage layer where your desired data is written\nand is indexed by hashing the key of your storage data.</p>\n<p>Given a limited key space hash functions will have collisions, it is therefore\nimportant that the KLM is significantly larger than required for fitting a key\nfor every object. To keep the likelihood of a collision low a naive\nimplementation would require an enourmous hash table but using a technique\ncalled Robin Hood hashing this requirement can be kept down to a small factor\nlarger than the size of the key set requirement.</p>\n<p>For example, in a blobstore which can fit <code>n</code> objects and that has a KLM which\ncan fit <code>2n</code> entries every hash would have a 50% chance of corresponding to an\nalready occupied slot. With Robin Hood hashing we can repeat this process\nmultiple times by incrementing an attempts counter giving us multiple possible\nlocations for the same object.</p>\n<p>When querying for an object we can then search up to the maximum number of\nallowed iterations to find our object in one of these slots. When inserting we\nperform a similar solution, namely incrementing the number of attempts whenever\nwe encounter a collision but taking care to insert the younger of the colliding\nobjects in the colliding slot and pushing the older object forward.</p>\n<p>The number of attempts we allow the KLM to look for a free slot is described by the two parameters <code>key_location_map_maximum_get_attempts</code> and the <code>key_location_map_maximum_put_attempts</code> described by the <a href=\"https://github.com/buildbarn/bb-storage/blob/0941111f29e31905e4081e6262bccf0c123940ed/pkg/proto/configuration/blobstore/blobstore.proto#L429\" target=\"_blank\" rel=\"noopener noreferrer\"><code>LocalBlobAccessConfiguration</code></a>.</p>\n<h1>So, how big should the KLM be?</h1>\n<p>Given a utilization rate <code>r</code> the chance of finding the object within <code>k</code>\niterations is <code>1-r^k</code>, we can therefore either decrease the utilization rate (by\nincreasing the size of the KLM) or increase the number of attempts.</p>\n<p>Due to the random access nature of the KLM the KLM greatly benefits from being\nsmall enough to fit in memory, even if the KLM itself is disk backed. Should the\nKLM be too big to fit in memory it will be constantly paged in and out\ndetrimenting the system performance.</p>\n<p>Simularly, there also needs to be a max number of iterations, in the degenerate\ncase where the storage fits more entries than the klm is capable of inserting is\nfull the algorithm would never terminate since every single slot would be\noccupied.</p>\n<p>Having a KLM that is too small for the number of iterations used is bad.</p>\n<p>This is somewhat mitigated by the insertion order where the oldest entries get pushed out first and therefore less likely to be relevant. This gives a graceful degradation for when your KLM is too small. You should choose a KLM so that the number of times you reach the maximum number of iterations is acceptably low.</p>\n<h1>How rare should you keep the maximum nuber of iterations?</h1>\n<p>It should be rare, but most objects that get discarded due to the KLM being full\nwill tend to be old and unused. There is however a point where it is no\nlonger meaningful to have a larger KLM.</p>\n<p>Ultimately, any time you read or write to a disk there is a risk of failure.\nPopularly this is described as happening due to cosmic radiation but more\nrealistically it is due random hardware failures from imperfections in the\nhardware.</p>\n<p>Picking <code>k</code> and <code>r</code> values that gives a risk of dataloss below the Uncorrectable\nBit Error Rate (UBER) of a disk is simply wasteful, should you wish to reduce\nthe risk below this value you need to look at mirroring data.</p>\n<p><a href=\"https://documents.westerndigital.com/content/dam/doc-library/en_us/assets/public/western-digital/product/internal-drives/wd-gold-ssd/product-brief-wd-gold-enterprise-class-nvme-ssd.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">Western\nDigital</a>\nadvertises that their Gold enterprise NVME disks has an UBER rate of 1 in 10^17,\ni.e. about once per 10 petabytes of read data so will serve as a decent\nstandard.</p>\n<p>For a random CAS object of 500KB this corresponds to 1 in 10^10, giving us this neat graph.</p>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"diagram\" src=\"https://meroton.github.io/assets/images/failure_rate-69a6d6185ef5b53dd044db62da88c274.svg\" width=\"605\" height=\"340\" class=\"img_ev3q\"></p>\n<p>That is, for a KLM using the recommended 16 iterations giving it more than\n4 entries per object in the storage is a waste since you are just as likely to\nfail to read the object due to disk errors as due to the KLM accidentally\npushing it out.</p>\n<p>Similarly for 32 iterations there is no point in having more than 2 entries per\nobject, and for 8 iterations there is no point in having more than 20 entries\nper object.</p>\n<p>As for number of put iterations, just keep it at 4x the number of get\niterations. There is no fancy math here, it just needs to be bigger than the\nnumber of get iterations and it is very cheap since you will only put objects a\nminiscule fraction of the amount of times you will get objects.</p>\n<p>The thought of data randomly getting lost might upset you spiritually, but you\ncan comfort yourself with that you are far more likely to lose due to AWS\nengineer tripping on a cable in the datacenter.</p>\n<h1>How do I verify if my KLMs are properly sized?</h1>\n<p>Buildbarn exposes this in it's Prometheus metrics, the metrics:\n<code>hashing_key_location_map_get_attempts</code>,\n<code>hashing_key_location_map_get_too_many_attempts_total</code>,\n<code>hashing_key_location_map_put_iterations</code> and\n<code>hashing_key_location_map_put_too_many_iterations_total</code> are relevant here which\nwill show you the trend of how many interations were required for each operation\nas well as keep track of the amount of times the algorithm failed with\n<code>too_many_iterations</code>.</p>\n<p>You can find ready made Grafana dashboards which visualizes these metrics in in\n<a href=\"https://github.com/buildbarn/bb-deployments\" target=\"_blank\" rel=\"noopener noreferrer\">bb-deployments</a>.</p>",
            "url": "https://meroton.github.io/blog/understanding-the-klm/",
            "title": "Understanding the KLM",
            "summary": "When running a remote cache and execution cluster based on Buildbarn the Key",
            "date_modified": "2024-11-11T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "buildbarn"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/introducing-buildbarn-fundamentals/",
            "content_html": "<p>At Meroton, we’ve long provided managed Buildbarn environments to help\ndevelopment teams streamline their build processes. Now, we’re excited to take\nit a step further with the introduction of our latest offering: Buildbarn\nFundamentals.</p>\n<p>This new course is designed to empower your team with the knowledge and\npractical skills needed to manage and operate your own Buildbarn environment.\nWhether you're just getting started with remote build execution or looking to\ntake control of your infrastructure, this hands-on course will provide you with\nthe tools to succeed.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"unlock-the-power-of-buildbarn-with-expert-guidance\">Unlock the Power of Buildbarn with Expert Guidance<a href=\"https://meroton.github.io/blog/introducing-buildbarn-fundamentals/#unlock-the-power-of-buildbarn-with-expert-guidance\" class=\"hash-link\" aria-label=\"Direct link to Unlock the Power of Buildbarn with Expert Guidance\" title=\"Direct link to Unlock the Power of Buildbarn with Expert Guidance\">​</a></h2>\n<p><strong>Buildbarn Fundamentals</strong> is more than just a training session; it’s an\nopportunity to set up a production-ready Buildbarn reference cluster in your own\nAWS environment. By participating in the course, your team will not only\nunderstand what makes Buildbarn tick but also walk away with a fully functional\nRemote Build Environment (RBE) cluster, which you can continue to use or adapt\nto your organization’s needs.</p>\n<p>At Meroton, we believe that mastering the management of remote build\nenvironments is crucial for modern development workflows. This course is\ndesigned to be both comprehensive and practical, offering a deep dive into\nBuildbarn while equipping your team with the operational knowledge to\neffectively maintain and scale your infrastructure.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"what-youll-learn\">What You'll Learn<a href=\"https://meroton.github.io/blog/introducing-buildbarn-fundamentals/#what-youll-learn\" class=\"hash-link\" aria-label=\"Direct link to What You'll Learn\" title=\"Direct link to What You'll Learn\">​</a></h2>\n<p>Buildbarn Fundamentals is a hands-on course that teaches participants how to:</p>\n<ul>\n<li>Set up a fully operational Buildbarn cluster in AWS</li>\n<li>Manage and operate Buildbarn clusters independently</li>\n<li>Integrate third-party tools to enhance your build environment and understand\nthe needs of consumers</li>\n<li>Optimize caching, remote execution, and troubleshooting with Buildbarn</li>\n</ul>\n<p>By the end of the course, your team will have the skills and confidence to\nself-manage a Buildbarn environment, enabling you to scale and optimize your\ndevelopment processes independently.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"more-information\">More Information<a href=\"https://meroton.github.io/blog/introducing-buildbarn-fundamentals/#more-information\" class=\"hash-link\" aria-label=\"Direct link to More Information\" title=\"Direct link to More Information\">​</a></h2>\n<p>If you're ready to empower your team with the skills to manage your own\nBuildbarn infrastructure, get in touch! Contact us at <a href=\"mailto:sales@meroton.com\" target=\"_blank\" rel=\"noopener noreferrer\">sales@meroton.com</a> to learn\nmore and secure your spot. Or read more at <a href=\"https://meroton.github.io/services/buildbarn-fundamentals/\">Buildbarn Fundamentals</a></p>",
            "url": "https://meroton.github.io/blog/introducing-buildbarn-fundamentals/",
            "title": "Introducing Meroton’s New Course: Buildbarn Fundamentals",
            "summary": "At Meroton, we’ve long provided managed Buildbarn environments to help",
            "date_modified": "2024-09-08T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "buildbarn",
                "meroton",
                "course"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/summer-buildbar-2024/",
            "content_html": "<p>Before heads out to summer adventures I'd like to invite everyone to a cool\nsummer Buildbar. At the Buildbar we'll eat good food, talk about interesting\ntechnical problems, new developments with Bazel and Buildbarn.</p>\n<p>And also have a few beers.</p>\n<p>Feel welcome to come over on Wednesday 19 June 2024, from 16 to 20.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"directions\">Directions<a href=\"https://meroton.github.io/blog/summer-buildbar-2024/#directions\" class=\"hash-link\" aria-label=\"Direct link to Directions\" title=\"Direct link to Directions\">​</a></h2>\n<p>You'll find us at our Linköping offices at Fridtunagatan 33. Currently there\nis some ongoing construction but follow the red lines and you'll be fine.</p>\n<figure><img alt=\"\" src=\"https://meroton.github.io/img/office_map.webp\"><figcaption>Fridtunagatan 33 Linköping</figcaption></figure>",
            "url": "https://meroton.github.io/blog/summer-buildbar-2024/",
            "title": "Summer Buildbar",
            "summary": "Before heads out to summer adventures I'd like to invite everyone to a cool",
            "date_modified": "2024-06-13T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "meroton",
                "afterwork"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/Automatically-reformat-all-commits-on-a-branch/",
            "content_html": "<p>If you have a formatter tool\nthat can rewrite your code\nyou can run it automatically on all unmerged commits.\nThis will show you how to script <code>git-rebase</code>\nto do so without any conflicts.</p>\n<p>There are two ways to do it manually, forward or backward.\nThe forward pass amends each commit\nand deals with the conflicts when stepping to the next commit.\nIn contrast the backwards pass, formats each commit from the end,\nwhich will avoid conflicts but for long commit chains it can be almost as boring.</p>\n<p>This pattern comes up when working with long-lived feature branches,\nor tasks that were almost done, and then pre-empted by other prioritized work.\nHere are a few oneliners you can run to tidy up your commits.</p>\n<p>See also the full technical guide for developing this <code>git-rebase</code> workflow\nin <a href=\"https://meroton.github.io/docs/practice/rebase-and-reformat-git-branches-automatically/\">our documentation</a>.\nWhich contains more details on rebasing with <code>git</code>,\nusing a scriptable editor to automate the <code>git-rebase</code> todo-list,\nas well as the squashed commit messages.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"example-commits\">Example commits<a href=\"https://meroton.github.io/blog/Automatically-reformat-all-commits-on-a-branch/#example-commits\" class=\"hash-link\" aria-label=\"Direct link to Example commits\" title=\"Direct link to Example commits\">​</a></h2>\n<p>Say you have three unmerged commits:</p>\n<p>21cc7b5 My amazing feature\ne05fd9f Other complimentary work\nacb9fae Fix annoying bug</p>\n<p>They contain important work, but you forgot to run some linters,\nor the main branch added more lint requirements\nafter the feature work was started.\nThis will run linters that can automatically fix issues on each commit\nthrough a scripted <code>git-rebase</code>.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"rebase-algorithm\">Rebase algorithm<a href=\"https://meroton.github.io/blog/Automatically-reformat-all-commits-on-a-branch/#rebase-algorithm\" class=\"hash-link\" aria-label=\"Direct link to Rebase algorithm\" title=\"Direct link to Rebase algorithm\">​</a></h2>\n<p>We have a three-step process to update each commit.</p>\n<ul>\n<li>\n<p>1: Create a fixup commit with the applied lint suggestions,\nwhich we immediately revert\nso the next commit still applies</p>\n<div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">#!/bin/sh</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Formatters and fixers go here.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Replace with your tools of choice! rustfmt, gofmt, black, ...</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">./run-all-linters-and-autofixers.sh</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Add a new commit with the changes and revert it again.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">git add -u</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">git commit --allow-empty --fixup HEAD</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># 'git-revert' does not support '--allow-empty'.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">git revert --no-commit HEAD</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">git commit --allow-empty --no-edit</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>\n<p>2: Squash the fixup commit into the original feature commit</p>\n</li>\n<li>\n<p>3: Squash the revert down into the next feature commit</p>\n</li>\n</ul>\n<p>These tabs show how the commits evolve and are squashed,\nthe extra commits are grouped to indicate the target commit.\nThe revert of the first commit is grouped with the second feature commit,\nand so on.\nWe discard the final revert.</p>\n<div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">Original</li><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">1: Reformated</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">2: Fixed-up</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">3: Fully-squashed</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">21cc7b5 My amazing feature</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">e05fd9f Other complimentary work</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">acb9fae Fix annoying bug</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">21cc7b5 My amazing feature</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">01900c5 fixup! My amazing feature</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">55feaba Revert \"fixup! My amazing feature\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">e05fd9f Other complimentary work</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">d122da7 fixup! Other complimentary work</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">249b0d3 Revert \"fixup! Other complimentary work\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">acb9fae Fix annoying bug</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">50e426a fixup! Fix annoying bug</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">7e84259 Revert \"fixup! Fix annoying bug\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">9ed9557 My amazing feature</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">55feaba Revert \"fixup! My amazing feature\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">0db521b Other complimentary work</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">249b0d3 Revert \"fixup! Other complimentary work\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">e2e991b Fix annoying bug</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">7e84259 Revert \"fixup! Fix annoying bug\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">9ed9557 My amazing feature</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">8e76352 Other complimentary work</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">f286036 Fix annoying bug</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"oneliners\">Oneliners<a href=\"https://meroton.github.io/blog/Automatically-reformat-all-commits-on-a-branch/#oneliners\" class=\"hash-link\" aria-label=\"Direct link to Oneliners\" title=\"Direct link to Oneliners\">​</a></h2>\n<p><code>git</code> allows us to set any editor to edit the todo-list, <code>$GIT_SEQUENCE_EDITOR</code>,\nand the commit message, <code>$EDITOR</code>.\nWe choose <code>vim</code> as it is often available, and easier to use than <code>sed</code> and <code>awk</code>.\nIt is nice to have a <em>scriptable</em> interactive editor\nto make changes to the workflow and try out the commands.</p>\n<p>See the <a href=\"https://meroton.github.io/docs/practice/rebase-and-reformat-git-branches-automatically/\">full technical guide</a> for details and more tips on <code>git-rebase</code> and <code>vim</code>.</p>\n<p>Reformat:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ env                          \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    GIT_SEQUENCE_EDITOR=\"true\" \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    git rebase -i --exec ./reformat.sh origin/main</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Fixup (autosquash):</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># More robust autosquash, that handles duplicated commit messages.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># If your commit messages are all unique you can use '--autosquash' instead.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># See the technical guide for more details.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ env                                                             \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    GIT_SEQUENCE_EDITOR=\"vim +'g/^\\w* \\w* fixup!/s/^pick/fixup/'\" \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    git rebase -i origin/main</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Squash:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ env                                                                                               \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    EDITOR=\"sed -i '1,9d'\"                                                                          \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    GIT_SEQUENCE_EDITOR=\"vim +'g/^#/d' +'normal! Gdk' +'g/^pick \\w* Revert \\\"fixup!/normal! j0ces'\" \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    git rebase -i origin/main</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"theme-admonition theme-admonition-info admonition_xJq3 alert alert--info\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_BuS1\"><p>We have not developed the <em>incantation</em>, <code>git-rebase</code> command,\nto preserve the author date from the original commits.\nWe will address that next!</p></div></div>",
            "url": "https://meroton.github.io/blog/Automatically-reformat-all-commits-on-a-branch/",
            "title": "Automatically Reformat all Commits on a Branch",
            "summary": "If you have a formatter tool",
            "date_modified": "2023-12-22T00:00:00.000Z",
            "author": {
                "name": "Nils Wireklint"
            },
            "tags": [
                "git",
                "unix",
                "linting"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/improved-chroot-in-buildbarn/",
            "content_html": "<p>We have just started a documentation series\ndescribing the Buildbarn <code>chroot</code> runners,\nand how they can be used for hermetic input roots\nthat contain all the required tools.\nThis includes implementation notes for a \"mountat\" functionality\ncreated through the new Linux mount API,\nhow you can use this under-documented API\nand its shortcomings.\nAnd how this <em>can/will be</em> integrated into Buildbarn,\nwith technical descriptions of the workers and runners.</p>\n<p>The first sections are already available, with more to come!</p>\n<p>Sections:</p>\n<ul>\n<li><a href=\"https://meroton.github.io/docs/improved-chroot-in-buildbarn/chroot-in-buildbarn/\">Use chroot in Buildbarn</a></li>\n<li><a href=\"https://meroton.github.io/docs/improved-chroot-in-buildbarn/implementing-mountat/\">Implement mountat with the new mount API</a></li>\n<li><a href=\"https://meroton.github.io/docs/improved-chroot-in-buildbarn/implementing-unmountat/\">Unmount from relative file paths and directory file descriptors</a></li>\n</ul>\n<p>Reference code repository:</p>\n<ul>\n<li><a href=\"https://github.com/meroton/prototype-mountat/\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/meroton/prototype-mountat/</a></li>\n</ul>",
            "url": "https://meroton.github.io/blog/improved-chroot-in-buildbarn/",
            "title": "Improved Chroot in Buildbarn",
            "summary": "We have just started a documentation series",
            "date_modified": "2023-12-01T00:00:00.000Z",
            "author": {
                "name": "Nils Wireklint"
            },
            "tags": [
                "linux",
                "syscalls",
                "buildbarn"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/buildbarn-updates-2023-11/",
            "content_html": "<p>This is a continuation of the\n<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/\">previous update article</a>\nand is a high level summary of what has happened in Buildbarn from 2023-02-16 to 2023-11-14.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"added-support-for-jwts-signed-with-rsa\">Added support for JWTs signed with RSA<a href=\"https://meroton.github.io/blog/buildbarn-updates-2023-11/#added-support-for-jwts-signed-with-rsa\" class=\"hash-link\" aria-label=\"Direct link to Added support for JWTs signed with RSA\" title=\"Direct link to Added support for JWTs signed with RSA\">​</a></h2>\n<p>Support for JWTs signed with RSA has been added.\nThe following JWT signing algorithms are now supported:</p>\n<ul>\n<li>HS256</li>\n<li>HS384</li>\n<li>HS512</li>\n<li>RS256</li>\n<li>RS384</li>\n<li>RS512</li>\n<li>EdDSA</li>\n<li>ES256</li>\n<li>ES384</li>\n<li>ES512</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"generalized-tuneables-for-linux-bdi-options\">Generalized tuneables for Linux BDI options<a href=\"https://meroton.github.io/blog/buildbarn-updates-2023-11/#generalized-tuneables-for-linux-bdi-options\" class=\"hash-link\" aria-label=\"Direct link to Generalized tuneables for Linux BDI options\" title=\"Direct link to Generalized tuneables for Linux BDI options\">​</a></h2>\n<p>Linux 6.2 added a sysfs attribute for toggling <code>BDI_CAP_STRICTLIMIT</code> on FUSE mounts.\nIf using the FUSE backed virtual file system on Linux 6.2\nadding <code>{ \"strict_limit\": \"0\" }</code> to <code>linux_backing_dev_info_tunables</code>\nwill remove the <code>BDI_CAP_STRICTLIMIT</code> flag from the FUSE mount.</p>\n<p>This may improve fileystem performance\nespecially when running build actions which\nuses mmap'ed files extensively.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"add-support-for-injecting-xcode-environment-variables\">Add support for injecting Xcode environment variables<a href=\"https://meroton.github.io/blog/buildbarn-updates-2023-11/#add-support-for-injecting-xcode-environment-variables\" class=\"hash-link\" aria-label=\"Direct link to Add support for injecting Xcode environment variables\" title=\"Direct link to Add support for injecting Xcode environment variables\">​</a></h2>\n<p>Remote build with macOS may call into locally installed copies of Xcode.\nThe path to the local copy of Xcode may vary\nand Bazel assumes that the remote execution service\nis capable of processing Xcode specific environment variables.</p>\n<p>See the <a href=\"https://github.com/buildbarn/bb-remote-execution/blob/master/pkg/proto/configuration/bb_runner/bb_runner.proto#L133\" target=\"_blank\" rel=\"noopener noreferrer\">proto files</a> for details.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"add-a-minimum-timestamp-to-actionresultexpiringblobaccess\">Add a minimum timestamp to ActionResultExpiringBlobAccess<a href=\"https://meroton.github.io/blog/buildbarn-updates-2023-11/#add-a-minimum-timestamp-to-actionresultexpiringblobaccess\" class=\"hash-link\" aria-label=\"Direct link to Add a minimum timestamp to ActionResultExpiringBlobAccess\" title=\"Direct link to Add a minimum timestamp to ActionResultExpiringBlobAccess\">​</a></h2>\n<p>A misbehaving worker may polluted the action cache,\nafter fixing the misbehaving worker\nwe would rather not throw away the entire action cache.</p>\n<p>A minimum timestamp in ActionResultExpiringBlobAccess\nallows us to mark a timestamp in the past\nbefore which the action should be considered invalid.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"add-authentication-to-http-servers\">Add authentication to HTTP servers<a href=\"https://meroton.github.io/blog/buildbarn-updates-2023-11/#add-authentication-to-http-servers\" class=\"hash-link\" aria-label=\"Direct link to Add authentication to HTTP servers\" title=\"Direct link to Add authentication to HTTP servers\">​</a></h2>\n<p>Much like the gRPC servers are capable of authenticated configuration\nthe http servers can now also require authentication.</p>\n<p>This allows the bb_browser and bb_scheduler UI\nto authenticate access using OAuth2 without involving any other middleware.</p>\n<p>This also allows us to add authorization configuration for administrative tasks\nsuch as draining workers or killing of jobs.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"authentication-using-a-json-web-key-set\">Authentication using a JSON Web Key Set<a href=\"https://meroton.github.io/blog/buildbarn-updates-2023-11/#authentication-using-a-json-web-key-set\" class=\"hash-link\" aria-label=\"Direct link to Authentication using a JSON Web Key Set\" title=\"Direct link to Authentication using a JSON Web Key Set\">​</a></h2>\n<p>JSON Web Key Sets (JWKS) is a standard format\nwhich allows us to specify multiple different encryption keys\nthat may have been used to sign our JWT authentication.</p>\n<p>Buildbarn can load the JWKS specification,\neither inline or as a file,\nwhen specifying trusted encryption keys.</p>\n<p>This allows us to have rotation with overlap of encryption keys.</p>",
            "url": "https://meroton.github.io/blog/buildbarn-updates-2023-11/",
            "title": "Updates to Buildbarn as of November 2023",
            "summary": "This is a continuation of the",
            "date_modified": "2023-11-21T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "release",
                "buildbarn"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/memory-adventure/",
            "content_html": "<p>An adventure in finding a memory thief in Starlark-land</p>\n<p>This is a summary and follow-up to <a href=\"https://www.youtube.com/watch?v=IXimf4DCAoY#t=7h21m57s\" target=\"_blank\" rel=\"noopener noreferrer\">my talk</a> at BazelCon-2023.\nWith abridged code examples, the full instructions are available <a href=\"https://github.com/meroton/memory-adventure\" target=\"_blank\" rel=\"noopener noreferrer\">together with the code</a>.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"problem-statement\">Problem Statement<a href=\"https://meroton.github.io/blog/memory-adventure/#problem-statement\" class=\"hash-link\" aria-label=\"Direct link to Problem Statement\" title=\"Direct link to Problem Statement\">​</a></h2>\n<p>First, we lament Bazel's out-of-memory errors,\nand point out that the often useful Starlark stacktrace does not always show up.\nSome allocation errors just crash Bazel without giving and indication of which allocation failed.</p>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"allocation\" src=\"https://meroton.github.io/assets/images/memory-allocation-failure-298bf3c0d8e472754fd513fa6c0ce57d.png\" width=\"1358\" height=\"952\" class=\"img_ev3q\"></p>\n<p>This diagram illustrates a common problem for memory errors,\nthe allocation that fails may not be the problem,\nit is just the straw that breaks the camel's back.\nAnd the real thief may already have allocated its memory.</p>\n<p>We have seen many errors when working with clients,\nand they typically hide in big corporate code bases.\nWhich complicates troubleshooting, discussion and error reporting.\nSo we create a synthetic repository to try to illustrate the problem,\nand have something to discuss.\nThe code and instructions are available <a href=\"https://github.com/meroton/memory-adventure\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\n<p>Errors and poor performance in the analysis phase\nare not good at all.\nThis is because the analysis must always be done\nbefore starting to build all actions.\nWith big projects the number of configuration to build for can be very large,\nso one cannot rely on CI runners to build the same configuration over and over,\nto retain the analysis cache.\nInstead it is on the critical-path for all builds,\nespecially if the actions themselves are cached remotely.</p>\n<p>To illustrate (some of the problem) we have a reproduction repository\nwith example code base with some Python and C programs.\nTo introduce memory problems, and make it a little more complex\nwe add two rules: one CPU intensive rule (\"spinlock\")\nand one memory intensive aspect (\"traverse\").\nThe \"traverse\" aspect encodes the full dependency tree of all targets\nand writes that to a file with <code>ctx.actions.write</code>.\nSo the allocations are tied to the Action object.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"toolbox\">Toolbox<a href=\"https://meroton.github.io/blog/memory-adventure/#toolbox\" class=\"hash-link\" aria-label=\"Direct link to Toolbox\" title=\"Direct link to Toolbox\">​</a></h2>\n<p>We have a couple of tools available, many are discussed in the <a href=\"https://bazel.build/rules/performance#memory-profiling\" target=\"_blank\" rel=\"noopener noreferrer\">memory optimization guide</a>,\nbut we find that some problems can slip through the cracks.</p>\n<p>First off, there are the post-build analysis tools in bazel:</p>\n<ul>\n<li><code>bazel info</code></li>\n<li><code>bazel dump --rules</code></li>\n<li><code>bazel aquery --skyframe_state</code></li>\n</ul>\n<p>These are a good starting point and have served us well on many occasions.\nBut with this project they seem to miss some allocations\nWe will return to that later.\nAdditionally, these tool will not give any information if the Bazel server crashes.\nYou will need to increase the memory and run the same build again.</p>\n<p>Then one can use Java tools to inspect what the JVM is doing:</p>\n<ul>\n<li><a href=\"https://eclipse.dev/mat/documentation/\" target=\"_blank\" rel=\"noopener noreferrer\">Eclipse Memory Analyzer</a></li>\n<li><code>jmap</code></li>\n</ul>\n<p>The best approach here is to ask Bazel to save the heap if it crashes,\nso it can be analyzed post-mortem: <code>bazel --heap_dump_on_oom</code></p>\n<p>And lastly, use Bazel's profiling information:</p>\n<ul>\n<li><code>bazel --profile=profile.gz --generate_json_trace_profile --noslim_profile</code></li>\n</ul>\n<p>This contains structured information\nand is written continuously to disk,\nso if Bazel crashes we can still parse it,\nwe just need to discard partially truncated events.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"expected-memory-consumption\">Expected Memory consumption<a href=\"https://meroton.github.io/blog/memory-adventure/#expected-memory-consumption\" class=\"hash-link\" aria-label=\"Direct link to Expected Memory consumption\" title=\"Direct link to Expected Memory consumption\">​</a></h2>\n<p>As the two rules write their string allocations to output files\nwe get a clear picture of the expected RAM usage (or at least a lower bound).</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ bazel clean</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ bazel build \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --aspects @example//memory:eat.bzl%traverse \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --output_groups=default,eat_memory \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  //...</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Memory intensive tree traversal (in KB)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ find bazel-out/ -name '*.tree' | xargs du | cut -f1 | paste -sd '+' | bc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">78504</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># CPU intensive spinlocks (in KB)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ find bazel-out/ -name '*.spinlock' | xargs du | cut -f1 | paste -sd '+' | bc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3400</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Here is a table with the data:</p>\n<table><thead><tr><th></th><th>Memory for each target</th><th>Total</th></tr></thead><tbody><tr><td>Memory intensive</td><td>0-17 MB</td><td>79 MB</td></tr><tr><td>CPU intensive</td><td>136 KB</td><td>3.4 MB</td></tr></tbody></table>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"reported-memory-consumption\">Reported Memory Consumption<a href=\"https://meroton.github.io/blog/memory-adventure/#reported-memory-consumption\" class=\"hash-link\" aria-label=\"Direct link to Reported Memory Consumption\" title=\"Direct link to Reported Memory Consumption\">​</a></h2>\n<p>Next, we check with the diagnostic tools.</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ bazel version</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Bazelisk version: development</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Build label: 6.4.0</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"bazel-dump---rules\">Bazel dump --rules<a href=\"https://meroton.github.io/blog/memory-adventure/#bazel-dump---rules\" class=\"hash-link\" aria-label=\"Direct link to Bazel dump --rules\" title=\"Direct link to Bazel dump --rules\">​</a></h3>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ bazel $STARTUP_FLAGS --host_jvm_args=-Xmx\"10g\" dump --rules</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Warning: this information is intended for consumption by developers</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">only, and may change at any time. Script against it at your own risk!</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">RULE                              COUNT     ACTIONS          BYTES         EACH</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">cc_library                            4          17        524,320      131,080</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">native_binary                         1           4        524,288      524,288</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">cc_binary                             6          54        262,176       43,696</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">toolchain_type                       14           0              0            0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">toolchain                            74           0              0            0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">...</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ASPECT                             COUNT     ACTIONS          BYTES         EACH</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">traverse                              85          81        262,432        3,087</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">spinlock14                            35          66        524,112       14,974</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">spinlock15                            35          66              0            0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">...</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>First, there are some common rules that we do not care about here,\nthen we have the Aspects.\n<code>traverse</code> is the memory intensive aspect,\nwhich is applied on the command line\nand <code>spinlock&lt;N&gt;</code> are the CPU intensive rules,\nwith identical implementations just numbered (there are 25 of them).</p>\n<p>It is a little surprising that only one have allocations.\nAnd the action count for each aspect does not make sense either,\nas this is not a transitive aspect.\nIt just runs a single action each time the rule is instantiated.\nThe hypothesis is that this is a display problem,\nwith code shared between rules.\nThere are 25 rules, with 25 distinct implementation functions,\nbut they in turn call the same function with the action.\nSo the \"count\" and \"actions\" columns are glued together,\nbut the \"bytes\" is reported for just one of the rules (it would be bad if this was double-counted).</p>\n<p>Either way,\nthe total number of bytes does not add up to what we expect.\nCompare the output to the lower-bound determined before:</p>\n<p>|  | Memory for each target | Total | Reported Total |\n| ---- | ---- | ----------- |\n| Memory intensive | 0-17 MB | 79 MB | 262 kB\n| CPU intensive | 136 KB |  3.4 MB | 524 kB</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"skylark-memory-profile\">Skylark Memory Profile<a href=\"https://meroton.github.io/blog/memory-adventure/#skylark-memory-profile\" class=\"hash-link\" aria-label=\"Direct link to Skylark Memory Profile\" title=\"Direct link to Skylark Memory Profile\">​</a></h3>\n<div class=\"theme-admonition theme-admonition-info admonition_xJq3 alert alert--info\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_BuS1\"><p>This is not part of the video.</p></div></div>\n<p>The skylark memory profiler is much more advanced,\nand can be dumped after a successful build.</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ bazel $STARTUP_FLAGS --host_jvm_args=-Xmx\"$mem\" dump \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    --skylark_memory=\"$dir/memory.pprof\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pprof manual/2023-10-30/10g-2/memory.pprof</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Main binary filename not available.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Type: memory</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Time: Oct 30, 2023 at 12:16pm (CET)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Entering interactive mode (type \"help\" for commands, \"o\" for options)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(pprof) top</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Showing nodes accounting for 2816.70kB, 73.34% of 3840.68kB total</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Showing top 10 nodes out of 19</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      flat  flat%   sum%        cum   cum%</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     512kB 13.33% 13.33%      512kB 13.33%  impl2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.16kB  6.67% 20.00%   256.16kB  6.67%  traverse_impl</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.11kB  6.67% 26.67%   256.11kB  6.67%  _add_linker_artifacts_output_groups</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.09kB  6.67% 33.34%   256.09kB  6.67%  alias</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.09kB  6.67% 40.00%   256.09kB  6.67%  rule</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.08kB  6.67% 46.67%   256.08kB  6.67%  to_list</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.06kB  6.67% 53.34%   256.06kB  6.67%  impl7</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.04kB  6.67% 60.01%   256.04kB  6.67%  _is_stamping_enabled</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.04kB  6.67% 66.67%   256.04kB  6.67%  impl18</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  256.03kB  6.67% 73.34%   768.15kB 20.00%  cc_binary_impl</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Here the Memory intensive aspect shows up with 256kB,\nwhich is inline with the output from <code>bazel dump --rules</code>,\nbut not reflecting the big allocations we know it makes.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"eclipse-memory-analyzer\">Eclipse Memory Analyzer<a href=\"https://meroton.github.io/blog/memory-adventure/#eclipse-memory-analyzer\" class=\"hash-link\" aria-label=\"Direct link to Eclipse Memory Analyzer\" title=\"Direct link to Eclipse Memory Analyzer\">​</a></h3>\n<p>The final tool we have investigated is the Java heap analysis tool\n<a href=\"https://eclipse.dev/mat/documentation/\" target=\"_blank\" rel=\"noopener noreferrer\">Eclipse Memory Analyzer</a>,\nwhich can easily be used with Bazel's <code>--heap_dump_on_oom</code> flag.\nOn the other hand it is a little tricker to find a heap dump from a successful build.</p>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"eclipse-analysis\" src=\"https://meroton.github.io/assets/images/eclipse-memory-analyzer-5f46da77b0ac91a7a92dc4c2d3b445b3.png\" width=\"1082\" height=\"402\" class=\"img_ev3q\"></p>\n<p>Here we see the (very) big allocation clear as day,\nbut have no information of its provenance.</p>\n<p>We have not found how to track this back to a Skylark function, Skyframe evaluator\nor anything that could be cross-referenced with the profiling information.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"build-time\">Build Time<a href=\"https://meroton.github.io/blog/memory-adventure/#build-time\" class=\"hash-link\" aria-label=\"Direct link to Build Time\" title=\"Direct link to Build Time\">​</a></h2>\n<p>The next section of the talk shows the execution time of the build\nwith varying memory limits.</p>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"combined\" src=\"https://meroton.github.io/assets/images/build-time-memory-plot-39f61e675034b7e845f9abdbfa8951f4.png\" width=\"640\" height=\"480\" class=\"img_ev3q\"></p>\n<p>This is benchmarked with 5 data points for each memory limit,\nand the plot shows failure if there was at least one crash among the data points.\nThere is a region where the build starts to succeed more and more often, but sometimes crashes.\nSo the Crash and not-crash graphs overlap a little,\nyou want to have some leeway to avoid flaky builds from occasional out-of-memory crashes.</p>\n<p>We see that the Skymeld graph requires a lot less memory than a regular build,\nthat is because our big allocations are all tied to Action objects.\nEnabling Skymeld lets Bazel start executing Actions as soon as they are ready,\nso the resident set of Action objects does not grow so large,\nand the allocations can be freed much sooner.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pessimization-with-limited-memory\">Pessimization with limited memory<a href=\"https://meroton.github.io/blog/memory-adventure/#pessimization-with-limited-memory\" class=\"hash-link\" aria-label=\"Direct link to Pessimization with limited memory\" title=\"Direct link to Pessimization with limited memory\">​</a></h2>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"pessimization\" src=\"https://meroton.github.io/assets/images/low-memory-pessimization-667ab96247ad01ee0ec7d5b75b830d84.png\" width=\"1212\" height=\"827\" class=\"img_ev3q\"></p>\n<p>We saw a hump in the build time for the Skymeld graph,\nwhere the builds did succeed in the 300 - 400 MB range,\nbut the build speed gradually increased, reaching a plateau at around 500 MB.\nThis is a pattern we have seen before,\nwhere more RAM, or more efficient rules can improve build performance.</p>\n<p>This is probably because the memory pressure and the Java Garbage Collector\ninterferes with the Skyframe work.\nSee <a href=\"https://www.youtube.com/watch?v=8Dc8R_Zrf6M&amp;t=3039s\" target=\"_blank\" rel=\"noopener noreferrer\">Benjamin Peterson's great talk</a> about the Skyframe for more information.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"future-work\">Future work<a href=\"https://meroton.github.io/blog/memory-adventure/#future-work\" class=\"hash-link\" aria-label=\"Direct link to Future work\" title=\"Direct link to Future work\">​</a></h2>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"example profile\" src=\"https://meroton.github.io/assets/images/example-chrome-tracing-424c445f4f5a56244ed23a270ba7c0c3.png\" width=\"809\" height=\"664\" class=\"img_ev3q\"></p>\n<p>This section details future work for more tools and signals\nthat we can find from Bazel's profile information\n<code>--profile=profile.gz --generate_json_trace_profile --noslim_profile</code>.\nWritten in the standard <code>chrome://tracing</code> format\nit is easy to parse for both successful and failed builds.</p>\n<p>This contains events for the garbage collector,\nand all executed Starlark functions.</p>\n<p>These can be correlated\nto find which functions are active during, or before, garbage collection events.\nAdditionally, one could collect this information for all failed builds,\nand see if some functions are overrepresented\namong the last active functions for each evaluator in the build.</p>",
            "url": "https://meroton.github.io/blog/memory-adventure/",
            "title": "Memory Adventure",
            "summary": "An adventure in finding a memory thief in Starlark-land",
            "date_modified": "2023-11-13T00:00:00.000Z",
            "author": {
                "name": "Nils Wireklint"
            },
            "tags": [
                "bazel",
                "buildbarn"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/bazelcon-2023/",
            "content_html": "<p>Meroton visited BazelCon 2023 in Munich October 24-25, 2023.\nDuring the conference, we held three talks:</p>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=8Dc8R_Zrf6M#t=7h36m20s\" target=\"_blank\" rel=\"noopener noreferrer\">Remote Output Service - How not to have your bytes and eat them too</a>\nby Benjamin Ingberg about bb_clientd and the Remote Output Service.</li>\n<li><a href=\"https://www.youtube.com/watch?v=IXimf4DCAoY#t=3h2m10s\" target=\"_blank\" rel=\"noopener noreferrer\">Buildbarn - From 100 to 100.000 CPUs</a>\n(<a href=\"https://docs.google.com/presentation/d/14qgMa1J9hBMTU017PlpQokKtS5n0KxJbJXPjndxqPqE/edit?usp=sharing&amp;resourcekey=0-OF3Hrwvr5G7aDnJG_ABRhw\" target=\"_blank\" rel=\"noopener noreferrer\">slides</a>)\nby Fredrik Medley.</li>\n<li><a href=\"https://www.youtube.com/watch?v=IXimf4DCAoY#t=7h21m57s\" target=\"_blank\" rel=\"noopener noreferrer\">Dude, where is my RAM? - An adventure in finding a RAM thief in Starlak land</a>\nby Nils Wireklint about difficulties in debugging out-of-memory errors in Bazel.</li>\n</ul>\n<p>Other talks that mentioned Buildbarn were:</p>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=8Dc8R_Zrf6M#t=5h41m5s\" target=\"_blank\" rel=\"noopener noreferrer\">Migrating a Multiple-Platform Game Engine to Bazel</a>\nwhere Kai Zhang from NetEase talks about a\n<a href=\"https://github.com/kkpattern/bb-remote-execution-py\" target=\"_blank\" rel=\"noopener noreferrer\">Buildbarn worker implementation in Python for Windows and MacOS</a>.</li>\n<li><a href=\"https://www.youtube.com/watch?v=8Dc8R_Zrf6M#t=7h56m2s\" target=\"_blank\" rel=\"noopener noreferrer\">Planting Bazel in barren soil: A Perl Story</a>\nwhere Manuel Naranjo from Booking.com is using Buildbarn for remote execution and Buildbuddy for Build Event Streaming.</li>\n</ul>\n<p>We are thankful for all amazing chats with the community and are looking forward to BazelCon 2024.</p>",
            "url": "https://meroton.github.io/blog/bazelcon-2023/",
            "title": "BazelCon 2023",
            "summary": "Meroton visited BazelCon 2023 in Munich October 24-25, 2023.",
            "date_modified": "2023-11-02T00:00:00.000Z",
            "author": {
                "name": "Fredrik Medley"
            },
            "tags": [
                "bazel",
                "buildbarn"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/buildbarn-block-sizes/",
            "content_html": "<p>When starting out with remote caching,\nan error you are likely to run into is:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">java.io.IOException: com.google.devtools.build.lib.remote.ExecutionStatusException:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">INVALID_ARGUMENT: Failed to store previous blob 1-&lt;HASH&gt;-&lt;LARGE_NUM&gt;:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Shard 1: Blob is &lt;LARGE_NUM&gt; bytes in size,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">while this backend is only capable of storing blobs of up to 238608384 bytes in size</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>This is because your storage backend is too small.\nYou are attempting to upload a blob larger than the largest blob accepted by your storage backend.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"how-do-i-fix-it\">How do I fix it?<a href=\"https://meroton.github.io/blog/buildbarn-block-sizes/#how-do-i-fix-it\" class=\"hash-link\" aria-label=\"Direct link to How do I fix it?\" title=\"Direct link to How do I fix it?\">​</a></h2>\n<p>The largest blob you can store is the size of your your storage device\ndivided by the number of blocks in your device.</p>\n<p>To store larger blobs,\neither increase the size of your storage device\nor decrease the number of blocks it is split into.\nLarger storage devices will take more disk,\nwhile fewer blocks will decrease the granularity which your cache works with.</p>\n<p>In\n<a href=\"https://github.com/buildbarn/bb-deployments\" target=\"_blank\" rel=\"noopener noreferrer\">bb-deployments</a>\nthis setting is found in\n<a href=\"https://github.com/buildbarn/bb-deployments/blob/d63c032b2b4d96f93cb889f95add15c26118d771/docker-compose/config/storage.jsonnet\" target=\"_blank\" rel=\"noopener noreferrer\">storage.jsonnet</a>.</p>\n<div class=\"language-js codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-js codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token literal-property property\" style=\"color:#36acaa\">contentAddressableStorage</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token literal-property property\" style=\"color:#36acaa\">backend</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token string-property property\" style=\"color:#36acaa\">'local'</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token literal-property property\" style=\"color:#36acaa\">oldBlocks</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">8</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token literal-property property\" style=\"color:#36acaa\">currentBlocks</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">24</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token literal-property property\" style=\"color:#36acaa\">newBlocks</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token literal-property property\" style=\"color:#36acaa\">blocksOnBlockDevice</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token literal-property property\" style=\"color:#36acaa\">source</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token literal-property property\" style=\"color:#36acaa\">file</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">              </span><span class=\"token literal-property property\" style=\"color:#36acaa\">path</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'/storage-cas/blocks'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">              </span><span class=\"token literal-property property\" style=\"color:#36acaa\">sizeBytes</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">8</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1024</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1024</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1024</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 8GiB</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token literal-property property\" style=\"color:#36acaa\">spareBlocks</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>To facilitate getting started bb-deployments emulates a block device by using an 8GiB large file.\nThis file is small enough to fit most builds while not taking over the disk completely from a developers machine.</p>\n<p>The device is then split into 36 blocks (8+24+1+3),\nwhere each block can then store a maximum of 238608384 bytes (8GiB / 36 - some alignment).</p>\n<p>In production it is preferable to use a large raw block device for this purpose.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"what-does-newoldcurrentspare-mean\">What does new/old/current/spare mean?<a href=\"https://meroton.github.io/blog/buildbarn-block-sizes/#what-does-newoldcurrentspare-mean\" class=\"hash-link\" aria-label=\"Direct link to What does new/old/current/spare mean?\" title=\"Direct link to What does new/old/current/spare mean?\">​</a></h2>\n<p>In depth documentation about all the settings are available in the\n<a href=\"https://github.com/buildbarn/bb-storage/blob/master/pkg/proto/configuration/blobstore/blobstore.proto\" target=\"_blank\" rel=\"noopener noreferrer\">configuration proto files</a>.</p>\n<p>In essence the storage works as a ringbuffer where the assignment of each block is rotated.\nConsider a 5 block configuration with 1 old, 2 current, 1 new and 1 spare block.</p>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"diagram\" src=\"https://meroton.github.io/assets/images/2023-04-11-buildbarn-block-size-1-15e36bcc18a3d4fcef69de02f8941f0e.svg\" width=\"1190\" height=\"559\" class=\"img_ev3q\"></p>\n<p>As data is referenced from an old block\nit gets written into a new block.\nWhen the new block is full the role rotates.</p>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"diagram\" src=\"https://meroton.github.io/assets/images/2023-04-11-buildbarn-block-size-2-6e29080d339215d72c87cdd8a8a0000b.svg\" width=\"1190\" height=\"559\" class=\"img_ev3q\"></p>\n<p>There are some tradeoffs in behaviour to consider when choosing your block layout. Fewer blocks will allow larger individual blobs at the cost of granularity. Here is a quick summary of the meaning of the different fields.</p>\n<ul>\n<li><strong>Old</strong> - Region where reads are actively copied over to new, too small value and your device behaves more like a FIFO than a LRU cache, too large and your device does a lot of uneccesary copying.</li>\n<li><strong>Current</strong> - Stable region, should be the majority of your device.</li>\n<li><strong>New</strong> - Region for writing new data to, must be 1 for AC and should be 1-4 for CAS. Having a couple of new blocks allows data to be better spread out over the device so as to not expire at the same time.</li>\n<li><strong>Spare</strong> - Region for giving ongoing reads some time to finish before data starts getting overwritten.</li>\n</ul>",
            "url": "https://meroton.github.io/blog/buildbarn-block-sizes/",
            "title": "Buildbarn Block Sizes",
            "summary": "When starting out with remote caching,",
            "date_modified": "2023-04-11T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "buildbarn"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/bb-deployments-updates-2023-02/",
            "content_html": "<p>The example configuration project for buildbarn\n<a href=\"https://github.com/buildbarn/bb-deployments\" target=\"_blank\" rel=\"noopener noreferrer\">bb-deployments</a>\nhas gotten updates.</p>\n<p>This is a continuation of the\n<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/\">updates from last year article</a>\nand is a high level summary of what has happened since April 2022 up to 2023-02-16.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"let-referenceexpandingblobaccess-support-gcs\">Let ReferenceExpandingBlobAccess support GCS<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#let-referenceexpandingblobaccess-support-gcs\" class=\"hash-link\" aria-label=\"Direct link to Let ReferenceExpandingBlobAccess support GCS\" title=\"Direct link to Let ReferenceExpandingBlobAccess support GCS\">​</a></h2>\n<p>ReferenceExpandingBlobAccess already supports S3 so support was extended to Google Cloud Storage buckets.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"support-for-prefetching-virtual-filesystems\">Support for prefetching Virtual Filesystems<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#support-for-prefetching-virtual-filesystems\" class=\"hash-link\" aria-label=\"Direct link to Support for prefetching Virtual Filesystems\" title=\"Direct link to Support for prefetching Virtual Filesystems\">​</a></h2>\n<p>Running workers with Fuse allows inputs for an action\nto be downloaded on demand.\nThis significantly reduces the amount of data\nthat gets sent in order to run overspecified actions.\nThis however leads to poor performance for actions\nwhich reads a lot of their inputs synchronously.</p>\n<p>With the prefetcher most of these actions can be recognized\nand data which is likely to be needed\ncan be downloaded ahead of time.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"support-for-sha256tree\">Support for sha256tree<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#support-for-sha256tree\" class=\"hash-link\" aria-label=\"Direct link to Support for sha256tree\" title=\"Direct link to Support for sha256tree\">​</a></h2>\n<p>Buildbarn has added support for\n<a href=\"https://github.com/bazelbuild/remote-apis/pull/235\" target=\"_blank\" rel=\"noopener noreferrer\">sha256tree</a>\nwhich uses sha256 hashing over a tree structure similar to blake3.</p>\n<p>This algorithm will allow large CAS objects to be chunked and decompositioned\nwith guaranteed data integrity while still using sha256 hardware instructions.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"completeness-checking-now-streams-rev2-tree-objects\">Completeness checking now streams REv2 Tree objects<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#completeness-checking-now-streams-rev2-tree-objects\" class=\"hash-link\" aria-label=\"Direct link to Completeness checking now streams REv2 Tree objects\" title=\"Direct link to Completeness checking now streams REv2 Tree objects\">​</a></h2>\n<p>This change introduces a small change to the configuration schema. If you previous had this:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">backend: { completenessChecking: ... },</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>You will now need to write something along these lines:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">backend: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    completenessChecking: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        backend: ...,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        maximumTotalTreeSizeBytes: 64 * 1024 * 1024,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    },</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">},</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>See also the\n<a href=\"https://github.com/buildbarn/bb-storage/commit/1b84fa824dc60e77776ce50e05c549fdf20c089b\" target=\"_blank\" rel=\"noopener noreferrer\">bb-storage commit 1b84fa8</a>.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"postponed-healthy-service-status\">Postponed healthy service status<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#postponed-healthy-service-status\" class=\"hash-link\" aria-label=\"Direct link to Postponed healthy service status\" title=\"Direct link to Postponed healthy service status\">​</a></h2>\n<p>The healthy and serving status,\ni.e. HTTP <code>/-/healthy</code> and\n<a href=\"https://pkg.go.dev/google.golang.org/grpc/health/grpc_health_v1#HealthCheckResponse_ServingStatus\" target=\"_blank\" rel=\"noopener noreferrer\">grpc_health_v1.HealthCheckResponse_SERVING</a>,\nare now postponed until the whole service is up and running.\nBefore, the healthy status was potentially reported before starting to listen to the gRPC ports.\nKubernetes will now wait until the service is up before forwarding connections to it.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"server-keepalive-parameter-options\">Server keepalive parameter options<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#server-keepalive-parameter-options\" class=\"hash-link\" aria-label=\"Direct link to Server keepalive parameter options\" title=\"Direct link to Server keepalive parameter options\">​</a></h2>\n<p>The option <code>buildbarn.configuration.grpc.ServerConfiguration.keepalive_parameters</code> can be used for L4 load balancing,\nto control when to ask clients to reconnect.\nFor default values, see\n<a href=\"https://pkg.go.dev/google.golang.org/grpc@v1.49.0/keepalive#ServerParameters\" target=\"_blank\" rel=\"noopener noreferrer\">keepalive.ServerParameters</a>.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"graceful-termination-of-localblobaccess\">Graceful termination of <code>LocalBlobAccess</code><a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#graceful-termination-of-localblobaccess\" class=\"hash-link\" aria-label=\"Direct link to graceful-termination-of-localblobaccess\" title=\"Direct link to graceful-termination-of-localblobaccess\">​</a></h2>\n<p>When <code>SIGTERM</code> or <code>SIGINT</code> is received, the <code>LocalBlobAccess</code> now synchronize data to disk before shutting down.\nDeployments using persistent storage will no longer observe loss of data when restarting the <code>bb_storage</code> services.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"non-sector-aligned-writes-to-block-device\">Non-sector Aligned Writes to Block Device<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#non-sector-aligned-writes-to-block-device\" class=\"hash-link\" aria-label=\"Direct link to Non-sector Aligned Writes to Block Device\" title=\"Direct link to Non-sector Aligned Writes to Block Device\">​</a></h2>\n<p>Using sector aligned storage is wasteful for the action cache where the messages are typically very small.\nBuildbarn can now fill all the gaps when writing, making storage more efficient.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"dag-shaped-blobaccess-configuration\">DAG Shaped BlobAccess Configuration<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#dag-shaped-blobaccess-configuration\" class=\"hash-link\" aria-label=\"Direct link to DAG Shaped BlobAccess Configuration\" title=\"Direct link to DAG Shaped BlobAccess Configuration\">​</a></h2>\n<p>Instead of a tree shaped BlobAccess configuration, the <code>with_labels</code> notation allows a directed acyclic graph.\nSee also the\n<a href=\"https://github.com/buildbarn/bb-storage/commit/cc295adc0f05cd579d48a65325ce54b54331c6a6\" target=\"_blank\" rel=\"noopener noreferrer\">bb-storage commit cc295ad</a>.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"nfsv4-as-worker-filesystem\">NFSv4 as worker filesystem<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#nfsv4-as-worker-filesystem\" class=\"hash-link\" aria-label=\"Direct link to NFSv4 as worker filesystem\" title=\"Direct link to NFSv4 as worker filesystem\">​</a></h2>\n<p>The <code>bb_worker</code> can now supply the working directory for <code>bb_runner</code> using NFSv4.\nPreviously, FUSE and hard linking files from the worker cache were the only two options.\nThis addition was mainly done to overcome the poor FUSE support on macOS.</p>\n<p>The NFSv4 server in <code>bb_worker</code> only supports macOS at the moment.\nNo effort has been spent to write custom mount logic for other systems yet.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"specify-forwardmetadata-with-a-jmespath\">Specify <code>forwardMetadata</code> with a JMESPath<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#specify-forwardmetadata-with-a-jmespath\" class=\"hash-link\" aria-label=\"Direct link to specify-forwardmetadata-with-a-jmespath\" title=\"Direct link to specify-forwardmetadata-with-a-jmespath\">​</a></h2>\n<p>Metadata forwarding is now more flexible, the JMESPath expressions can for example add authorization result data.\nThe format is described in\n<a href=\"https://github.com/buildbarn/bb-storage/blob/0c2fcad5872b0fef47bb5bee8aba9518dc2fe465/pkg/proto/configuration/grpc/grpc.proto#L55-L93\" target=\"_blank\" rel=\"noopener noreferrer\">grpc.proto</a>.</p>\n<p>A common use case is to replace</p>\n<div class=\"language-jsonnet codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-jsonnet codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">{</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    forwardMetadata: [\"build.bazel.remote.execution.v2.requestmetadata-bin\"],</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>with</p>\n<div class=\"language-jsonnet codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-jsonnet codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">{</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    addMetadataJmespathExpression: '{</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        \"build.bazel.remote.execution.v2.requestmetadata-bin\":</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            incomingGRPCMetadata.\"build.bazel.remote.execution.v2.requestmetadata-bin\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    }',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"tracing-deprecate-the-jaeger-collector-span-exporter\">Tracing: Deprecate the Jaeger collector span exporter<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#tracing-deprecate-the-jaeger-collector-span-exporter\" class=\"hash-link\" aria-label=\"Direct link to Tracing: Deprecate the Jaeger collector span exporter\" title=\"Direct link to Tracing: Deprecate the Jaeger collector span exporter\">​</a></h2>\n<p>This option is deprecated, as Jaeger 1.35 and later provide native support for the OpenTelemetry protocol.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"bb-deployments-ubuntu-2204-example-runner-image\"><code>bb-deployments</code> Ubuntu 22.04 Example Runner Image<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#bb-deployments-ubuntu-2204-example-runner-image\" class=\"hash-link\" aria-label=\"Direct link to bb-deployments-ubuntu-2204-example-runner-image\" title=\"Direct link to bb-deployments-ubuntu-2204-example-runner-image\">​</a></h2>\n<p>The <a href=\"https://github.com/bazelbuild/bazel-toolchains/blob/4.0.0/rules/rbe_repo.bzl#L896\" target=\"_blank\" rel=\"noopener noreferrer\">rbe_autoconfig</a>\nin <a href=\"https://github.com/bazelbuild/bazel-toolchains\" target=\"_blank\" rel=\"noopener noreferrer\">bazel-toolchains</a>\nhas been deprecated. In bb-deployments it has been replaced by the\n<a href=\"https://github.com/nektos/act/blob/master/IMAGES.md\" target=\"_blank\" rel=\"noopener noreferrer\">Act</a> image\n<a href=\"https://github.com/catthehacker/docker_images\" target=\"_blank\" rel=\"noopener noreferrer\">ghcr.io/catthehacker/ubuntu<!-- -->:act-22<!-- -->.04</a>,\ndistributed by <a href=\"https://github.com/catthehacker/docker_images\" target=\"_blank\" rel=\"noopener noreferrer\">catthehacker</a>,\nused for running GitHub Actions locally under Ubuntu 22.04.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"bb-deployments-integration-tests\"><code>bb-deployments</code> Integration Tests<a href=\"https://meroton.github.io/blog/bb-deployments-updates-2023-02/#bb-deployments-integration-tests\" class=\"hash-link\" aria-label=\"Direct link to bb-deployments-integration-tests\" title=\"Direct link to bb-deployments-integration-tests\">​</a></h2>\n<p>The <a href=\"https://github.com/buildbarn/bb-deployments/tree/ce123473f27290648d1e56f7072468eb6b67fefb/bare\" target=\"_blank\" rel=\"noopener noreferrer\">bare deployment</a> and\n<a href=\"https://github.com/buildbarn/bb-deployments/tree/ce123473f27290648d1e56f7072468eb6b67fefb/docker-compose\" target=\"_blank\" rel=\"noopener noreferrer\">Docker Compose deployment</a>\nhave now got <a href=\"https://github.com/buildbarn/bb-deployments/tree/ce123473f27290648d1e56f7072468eb6b67fefb/tools\" target=\"_blank\" rel=\"noopener noreferrer\">tests scripts</a>\nthat builds and tests <code>@abseil-hello//:hello_test</code> remotely, shuts down and then checks for 100% cache hit after restart.\nAnother CI test is checking for minimal differences between the Docker Compose deployment and\nthe <a href=\"https://github.com/buildbarn/bb-deployments/tree/ce123473f27290648d1e56f7072468eb6b67fefb/kubernetes\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes deployment</a>.</p>\n<p>If there are any other changes you feel deserve a mention\nfeel free to submit a pull request at github using the link below.</p>",
            "url": "https://meroton.github.io/blog/bb-deployments-updates-2023-02/",
            "title": "Updates to Buildbarn deployment repo as of Febuary 2023",
            "summary": "The example configuration project for buildbarn",
            "date_modified": "2023-02-21T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "release",
                "buildbarn"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/bazel-6-errors-build-without-the-bytes/",
            "content_html": "<p><em>** UPDATE: ** Bazel has a workaround for this issue\npreventing the permanent build failure loop from 6.1.0 and\na proper fix with the introduction of\n<a href=\"https://bazel.build/reference/command-line-reference#flag--experimental_remote_cache_ttl\" target=\"_blank\" rel=\"noopener noreferrer\"><code>--experimental_remote_cache_ttl</code></a>\nin Bazel 7</em></p>\n<hr>\n<p>Starting from v6.0.0, Bazel crashes when building without the bytes.\nBecause it sets <code>--experimental_action_cache_store_output_metadata</code>\nwhen using <code>--remote_download_minimal</code> or <code>--remote_download_toplevel</code>.</p>\n<p>Effectively this leads to Bazel getting stuck in a build failure loop\nwhen your remote cache evicts an item you need from the cache.</p>\n<div class=\"language-console codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-console codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">developer@machine:~$ bazel test @abseil-hello//:hello_test --remote_download_</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">minimal</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[0 / 6] [Prepa] BazelWorkspaceStatusAction stable-status.txt</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ERROR: /home/developer/.cache/bazel/_bazel_developer/139b99b96c4ab6cba5122193</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">1a36e346/external/abseil-hello/BUILD.bazel:26:8: Linking external/abseil-hell</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">o/hello_test failed: (Exit 34): 42 errors during bulk transfer:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">java.io.FileNotFoundException: /home/developer/.cache/bazel/_bazel_developer/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">139b99b96c4ab6cba51221931a36e346/execroot/cache_test/bazel-out/k8-fastbuild/b</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">in/external/com_google_absl/absl/base/_objs/base/spinlock.pic.o (No such file</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> or directory)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">...</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Target @abseil-hello//:hello_test failed to build</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Use --verbose_failures to see the command lines of failed build steps.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">INFO: Elapsed time: 3.820s, Critical Path: 0.88s</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">INFO: 5 processes: 4 internal, 1 remote.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FAILED: Build did NOT complete successfully</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@abseil-hello//:hello_test                                   FAILED TO BUILD</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>The key here is <strong>(Exit 34): xx errors during bulk transfer</strong>.\n34 is Bazel's error code for Remote Error.</p>\n<p>The recommended solution is to set the flag explicitly to false,\nwith <code>--experimental_action_cache_store_output_metadata=false</code>.\nTo quickly solve the issue on your local machine you can run <code>bazel clean</code>.\nHowever, this will just push the error into the future.</p>\n<p>The bug is independent of which remote cache system you use\nand is tracked at <a href=\"https://github.com/bazelbuild/bazel/issues/17366\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub</a>.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"background\">Background<a href=\"https://meroton.github.io/blog/bazel-6-errors-build-without-the-bytes/#background\" class=\"hash-link\" aria-label=\"Direct link to Background\" title=\"Direct link to Background\">​</a></h2>\n<p>When performing an analysis of what to build\nBazel will ask the remote cache which items have already been built.\nBazel will only schedule build actions for items\nthat do not already exist in the cache.\nIf running a build without the bytes<sup><a href=\"https://meroton.github.io/blog/bazel-6-errors-build-without-the-bytes/#user-content-fn-1-13c049\" id=\"user-content-fnref-1-13c049\" data-footnote-ref=\"true\" aria-describedby=\"footnote-label\">1</a></sup>\nthe intermediary results will not be downloaded to the client.</p>\n<p>Should the cached items be evicted\nthen Bazel will run into an unrecoverable error.\nIt wants the remote system to perform an action using inputs from the cache,\nbut they have disappeared.\nAnd Bazel can not upload them,\nas they were never downloaded to the client.\nThe build would then dutifully crash\n(some work has been put into trying to\n<a href=\"https://groups.google.com/g/bazel-dev/c/WwNN4kiYSpc\" target=\"_blank\" rel=\"noopener noreferrer\">resolve this on the bazel side</a>\nbut it has not been considered a priority).</p>\n<p>This puts an implicit requirement on the remote cache implementation.\nArtifacts need to be saved for as long as Bazel needs them.\nThe problem here is that this is an undefined period of time.\nBazel will not proactively check if the item still exists,\nnor in any other manner inform the cache that\nit will need the item in the future.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"before-v600\">Before v6.0.0<a href=\"https://meroton.github.io/blog/bazel-6-errors-build-without-the-bytes/#before-v600\" class=\"hash-link\" aria-label=\"Direct link to Before v6.0.0\" title=\"Direct link to Before v6.0.0\">​</a></h2>\n<p>Bazel tied the lifetime of which items already exists in the cache\n(the existence cache)\nto the analysis cache.\nWhenever the analysis cache was purged it would also drop the existence cache.</p>\n<p>The analysis cache is purged quite frequently.\nIt would therefore be rare in practice,\nthat the existence cache would be out of date.\nFurthermore, since the existence cache was an in-memory cache,\nBazel crashing would forcefully evict the existence cache.\nThereby fixing the issue.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"after-v600\">After v6.0.0<a href=\"https://meroton.github.io/blog/bazel-6-errors-build-without-the-bytes/#after-v600\" class=\"hash-link\" aria-label=\"Direct link to After v6.0.0\" title=\"Direct link to After v6.0.0\">​</a></h2>\n<p>With the\n<code>--experimental_action_cache_store_output_metadata</code> flag enabled by default\nthe existence cache is instead committed to disk and\nnever dropped during normal operation.</p>\n<p>This means two things:</p>\n<ol>\n<li>The implied requirement on the remote cache is effectively infinite.</li>\n<li>Should this requirement not be met the build will fail.\nAnd since the existence cache is committed to disk Bazel will just\nfail again the next time you run it.</li>\n</ol>\n<p>Currently the only user-facing way of purging the existence cache\nis to run <code>bazel clean</code>.\nWhich is generally considered an anti-pattern.</p>\n<p>If you are using the <a href=\"https://github.com/buildbarn/bb-clientd#-to-perform-remote-builds-without-the-bytes\" target=\"_blank\" rel=\"noopener noreferrer\">bb-clientd</a> <code>--remote_output_service</code>\nto run builds without the bytes\n(an alternative strategy to <code>--remote_download_minimal</code>)\nthis will not affect you.</p>\n<!-- -->\n<section data-footnotes=\"true\" class=\"footnotes\"><h2 class=\"anchor anchorWithStickyNavbar_LWe7 sr-only\" id=\"footnote-label\">Footnotes<a href=\"https://meroton.github.io/blog/bazel-6-errors-build-without-the-bytes/#footnote-label\" class=\"hash-link\" aria-label=\"Direct link to Footnotes\" title=\"Direct link to Footnotes\">​</a></h2>\n<ol>\n<li id=\"user-content-fn-1-13c049\">\n<p>When using Bazel with remote execution\nremote builds are run in a remote server cluster.\nThere is therefore no need for each developer\nto download the partial results of build.\nBazel calls this feature\n<a href=\"https://blog.bazel.build/2019/05/07/builds-without-bytes.html\" target=\"_blank\" rel=\"noopener noreferrer\">Remote Builds Without the Bytes</a>.\nThe progress of the feature can be tracked at\n<a href=\"https://github.com/bazelbuild/bazel/issues/6862\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub</a>. <a href=\"https://meroton.github.io/blog/bazel-6-errors-build-without-the-bytes/#user-content-fnref-1-13c049\" data-footnote-backref=\"\" aria-label=\"Back to reference 1\" class=\"data-footnote-backref\">↩</a></p>\n</li>\n</ol>\n</section>",
            "url": "https://meroton.github.io/blog/bazel-6-errors-build-without-the-bytes/",
            "title": "Bazel 6 Errors when using Build without the Bytes",
            "summary": "_ UPDATE:  Bazel has a workaround for this issue",
            "date_modified": "2023-02-07T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "bazel",
                "bugs"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/buildbar-at-meroton-office/",
            "content_html": "<p>After BazelCon we've all gotten a bit giddy and you might feel excited how the information presented at BazelCon might impact your development workflow.\nFor that purpose we're inviting everyone in the wider bazel community to an open BuildBar at the Meroton offices.</p>\n<p>Come over and digest BazelCon with high level technical discussions of the talks,\ngreat company, a pleasant atmosphere and also beer.</p>\n<p>Feel welcome to come over this Thursday the first of December from 16 to 20.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"directions\">Directions<a href=\"https://meroton.github.io/blog/buildbar-at-meroton-office/#directions\" class=\"hash-link\" aria-label=\"Direct link to Directions\" title=\"Direct link to Directions\">​</a></h2>\n<p>You'll find us at our Linköping offices at Fridtunagatan 33. Currently there is some construction but follow the red lines and you'll be fine.</p>\n<figure><img alt=\"\" src=\"https://meroton.github.io/img/office_map.webp\"><figcaption>Fridtunagatan 33 Linköping</figcaption></figure>",
            "url": "https://meroton.github.io/blog/buildbar-at-meroton-office/",
            "title": "BuildBar at the Meroton Office",
            "summary": "After BazelCon we've all gotten a bit giddy and you might feel excited how the information presented at BazelCon might impact your development workflow.",
            "date_modified": "2022-11-24T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "meroton",
                "afterwork"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/remote-executors-for-free-tier/",
            "content_html": "<p>We've performed some updates to the free tier and our pricing model.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"shared-cache\">Shared Cache<a href=\"https://meroton.github.io/blog/remote-executors-for-free-tier/#shared-cache\" class=\"hash-link\" aria-label=\"Direct link to Shared Cache\" title=\"Direct link to Shared Cache\">​</a></h2>\n<p>The free tier has been upgraded into an environment with a 1TB cache.\nThis means that you can use the free tier without worrying about hitting any limits or setup process.</p>\n<p>Do note that while the cached items will only be accessible with the correct api keys,\nthe storage area can be reclaimed by anyone.\nI.e. as the cache becomes full your items might be dropped.</p>\n<p>With the current churn we expect any items in the cache last at least a week.\nHowever, you should always treat items in the cache as something which might be dropped at any moment.\nThe purpose and design of the cache is to maximize build performance, not to provide storage.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"shared-executors\">Shared executors<a href=\"https://meroton.github.io/blog/remote-executors-for-free-tier/#shared-executors\" class=\"hash-link\" aria-label=\"Direct link to Shared executors\" title=\"Direct link to Shared executors\">​</a></h2>\n<p>New for the free environment is the introduction of remote execution,\nthis was previously only available for paying customers.</p>\n<p>If you're using bazel you can simply add the <code>--remote_executor=&lt;...&gt;</code> flag and your builds will be done remotely.</p>\n<p>The free environment has access to 64 shared executors.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"starter-tier\">Starter tier<a href=\"https://meroton.github.io/blog/remote-executors-for-free-tier/#starter-tier\" class=\"hash-link\" aria-label=\"Direct link to Starter tier\" title=\"Direct link to Starter tier\">​</a></h2>\n<p>If you need dedicated storage for evaluation purposes we also offer a starter tier.\nThe starter tier is a streamlined environment with 100 GB of dedicated cache and access to the same 64 executors as the free tier.</p>\n<p>This allows you to try out remote execution and caching without being disturbed by others.\nWhile the 100GB dedicated cache will only be used by you and therefore not be overwritten by anyone else's build,\nthe cache is still a cache and the system will still drop the cache entries if it determines it is useful for maximizing performance.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"need-more-executors\">Need more executors?<a href=\"https://meroton.github.io/blog/remote-executors-for-free-tier/#need-more-executors\" class=\"hash-link\" aria-label=\"Direct link to Need more executors?\" title=\"Direct link to Need more executors?\">​</a></h2>\n<p>At the moment the starter tier has a fixed amount of shared executors.\nIf you need a scalable solution contact us for setting up a custom Buildbarn environment of any size.</p>",
            "url": "https://meroton.github.io/blog/remote-executors-for-free-tier/",
            "title": "Remote Executors for the Free Environment",
            "summary": "We've performed some updates to the free tier and our pricing model.",
            "date_modified": "2022-10-13T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "meroton",
                "remote execution",
                "cloud",
                "free tier",
                "starter tier"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/tips-trix-and-nondeterminism/",
            "content_html": "<p>When you have a remote build and cache cluster it can sometimes be hard to track down what exactly is using all of your building resources. To help with this we have started a tips and trix section in the documentation where we will share methods we use to debug and resolve slow builds.</p>\n<p>The first section is about build non-determinism. Ideally your build actions should produce the same output when run with the same input, in practice this is sometimes not the case. If you are lucky a non-deterministic action won't be noticed since the inputs for the non-deterministic action is unchanged it won't be rebuilt.</p>\n<p>If you're not so lucky the non-determinism stems from a bug in the implementation and you should definitely pay attention to them. But how do you know which if any actions are non-deterministic?</p>\n<p>This is not trivial but we have added <a href=\"https://meroton.github.io/docs/tips/non-deterministic-builds/\">a server side feature</a> which allows detection of non-determinism with virtually no effort on your part.</p>\n<p>Once activated it reruns a configured fraction of your actions and automatically flags them if they produce different outputs. The scheduling is done outside of your bazel invocation so your build throughput will be unaffected at the cost of an increase in the number of resources consumed. We suggest 1% which will only increase your resource use by a trivial amount but you could of course set it to 100% which would double the cost of your builds.</p>",
            "url": "https://meroton.github.io/blog/tips-trix-and-nondeterminism/",
            "title": "Tips, Tricks & Non-Deterministic Builds",
            "summary": "When you have a remote build and cache cluster it can sometimes be hard to track down what exactly is using all of your building resources. To help with this we have started a tips and trix section in the documentation where we will share methods we use to debug and resolve slow builds.",
            "date_modified": "2022-08-28T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "meroton",
                "bazel",
                "optimizing"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/bb-deploy-updates-2022-04/",
            "content_html": "<p>The <a href=\"https://github.com/buildbarn/bb-deployments\" target=\"_blank\" rel=\"noopener noreferrer\">sample configuration project for Buildbarn</a> was recently updated after a long hiatus. As an aid for people to understand which changes have been done see the following high level summary.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"april-2022-updates\">April 2022 Updates<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#april-2022-updates\" class=\"hash-link\" aria-label=\"Direct link to April 2022 Updates\" title=\"Direct link to April 2022 Updates\">​</a></h2>\n<p>This includes updates to Buildbarn since December 2020.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"authorizer-overhaul\">Authorizer Overhaul<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#authorizer-overhaul\" class=\"hash-link\" aria-label=\"Direct link to Authorizer Overhaul\" title=\"Direct link to Authorizer Overhaul\">​</a></h3>\n<p>Authorizers have been rehauled to be more flexible it is now part of each individual cache and execution configuration.</p>\n<p>Using a JWT authorization bearer token has been added as an authorization method.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"hierarchical-blob-access\">Hierarchical Blob Access<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#hierarchical-blob-access\" class=\"hash-link\" aria-label=\"Direct link to Hierarchical Blob Access\" title=\"Direct link to Hierarchical Blob Access\">​</a></h3>\n<p>Using hierarchical blob access allows blobs in instance name <code>foo/bar</code> to be accessed from instance <code>foo/bar/baz</code> but not instance <code>foo</code> or <code>foo/qux</code>.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"action-result-expiration\">Action Result Expiration<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#action-result-expiration\" class=\"hash-link\" aria-label=\"Direct link to Action Result Expiration\" title=\"Direct link to Action Result Expiration\">​</a></h3>\n<p>An expiry can be added to action result which lets the action cache purge the result of an exection that was performed too far in the past. This can be used to ensure that all targets are rebuilt periodically even if they are accessed frequently enough to not normally be purged from the cache.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"read-only-cache-replicas\">Read Only Cache Replicas<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#read-only-cache-replicas\" class=\"hash-link\" aria-label=\"Direct link to Read Only Cache Replicas\" title=\"Direct link to Read Only Cache Replicas\">​</a></h3>\n<p>Cache read traffic can now be sent to a read-only replica which is periodically probed for availability.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"concurrency-limiting-blob-replication\">Concurrency Limiting Blob Replication<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#concurrency-limiting-blob-replication\" class=\"hash-link\" aria-label=\"Direct link to Concurrency Limiting Blob Replication\" title=\"Direct link to Concurrency Limiting Blob Replication\">​</a></h3>\n<p>Limit the number of concurrent replications to prevent network starvation</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"run-commands-as-another-user\">Run Commands as Another User<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#run-commands-as-another-user\" class=\"hash-link\" aria-label=\"Direct link to Run Commands as Another User\" title=\"Direct link to Run Commands as Another User\">​</a></h3>\n<p>Allows the commands to be run as a different user, on most platforms this means the bb-runner instance must run as root.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"size-class-analysis\">Size Class Analysis<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#size-class-analysis\" class=\"hash-link\" aria-label=\"Direct link to Size Class Analysis\" title=\"Direct link to Size Class Analysis\">​</a></h3>\n<p>Allows executors of different size classes to be used, the scheduler will attempt to utilize executors efficiently but there is an inherent tradeof between throughput and latency. Once configured the scheduler will automatically attempt to keep track of which actions are best run on which executors.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"execution-routing-policy\">Execution Routing Policy<a href=\"https://meroton.github.io/blog/bb-deploy-updates-2022-04/#execution-routing-policy\" class=\"hash-link\" aria-label=\"Direct link to Execution Routing Policy\" title=\"Direct link to Execution Routing Policy\">​</a></h3>\n<p>The scheduler accepts an execution routing policy configuration that allows it to determine how to defer builds to different executors.</p>\n<p>If you see any other changes you feel should get a mention feel free to submit a pull request at github using the link below.</p>",
            "url": "https://meroton.github.io/blog/bb-deploy-updates-2022-04/",
            "title": "Updates to Buildbarn deployment repo as of April 2022",
            "summary": "The sample configuration project for Buildbarn was recently updated after a long hiatus. As an aid for people to understand which changes have been done see the following high level summary.",
            "date_modified": "2022-05-04T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "release",
                "buildbarn"
            ]
        },
        {
            "id": "https://meroton.github.io/blog/about/",
            "content_html": "<p>The purpose of these articles is to have a freeform area discussing ideas, technical issues, solutions and news in an indepth relaxed manner. It is not to serve as reference material, structured reference material should be available in the documentation section.</p>\n<p>The article format allows more in depth on discussions for reacurring subjects. In contrast to the documentation published articles aren't changed, if the subject requires a revisit in the future then we publish a new post and add references to the old.</p>\n<p>If you see any errors feel free to submit a pull request at github using the link below.</p>",
            "url": "https://meroton.github.io/blog/about/",
            "title": "Purpose of the Articles",
            "summary": "The purpose of these articles is to have a freeform area discussing ideas, technical issues, solutions and news in an indepth relaxed manner. It is not to serve as reference material, structured reference material should be available in the documentation section.",
            "date_modified": "2022-02-22T00:00:00.000Z",
            "author": {
                "name": "Benjamin Ingberg"
            },
            "tags": [
                "meroton"
            ]
        }
    ]
}