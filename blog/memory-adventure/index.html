<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Memory Adventure | Meroton</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://meroton.github.io/blog/memory-adventure/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Memory Adventure | Meroton"><meta data-rh="true" name="description" content="An adventure in finding a memory thief in Starlark-land"><meta data-rh="true" property="og:description" content="An adventure in finding a memory thief in Starlark-land"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-11-13T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="bazel,buildbarn"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://meroton.github.io/blog/memory-adventure/"><link data-rh="true" rel="alternate" href="https://meroton.github.io/blog/memory-adventure/" hreflang="en"><link data-rh="true" rel="alternate" href="https://meroton.github.io/blog/memory-adventure/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://meroton.github.io/blog/memory-adventure","mainEntityOfPage":"https://meroton.github.io/blog/memory-adventure","url":"https://meroton.github.io/blog/memory-adventure","headline":"Memory Adventure","name":"Memory Adventure","description":"An adventure in finding a memory thief in Starlark-land","datePublished":"2023-11-13T00:00:00.000Z","author":{"@type":"Person","name":"Nils Wireklint","image":"/img/nils-avatar.jpg"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://meroton.github.io/blog","name":"Meroton Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title=" RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title=" Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title=" JSON Feed">




<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LVF8V72WEQ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-LVF8V72WEQ",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.24067a74.css">
<script src="/assets/js/runtime~main.5878f6cb.js" defer="defer"></script>
<script src="/assets/js/main.47cb6dce.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Meroton" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Meroton" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Meroton</b></a><a class="navbar__item navbar__link" href="/docs/intro/">Documentation</a><a class="navbar__item navbar__link" href="/services/">Services</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://forms.gle/wchwDu6roWg6A7U29" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Sign up<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All articles</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bazel-buildbarn-and-bonanza/">Bazel, Buildbarn and Bonanza</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/understanding-the-klm/">Understanding the KLM</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-buildbarn-fundamentals/">Introducing Merotonâ€™s New Course: Buildbarn Fundamentals</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/summer-buildbar-2024/">Summer Buildbar</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Automatically-reformat-all-commits-on-a-branch/">Automatically Reformat all Commits on a Branch</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/improved-chroot-in-buildbarn/">Improved Chroot in Buildbarn</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/buildbarn-updates-2023-11/">Updates to Buildbarn as of November 2023</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/memory-adventure/">Memory Adventure</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bazelcon-2023/">BazelCon 2023</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/buildbarn-block-sizes/">Buildbarn Block Sizes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bb-deployments-updates-2023-02/">Updates to Buildbarn deployment repo as of Febuary 2023</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bazel-6-errors-build-without-the-bytes/">Bazel 6 Errors when using Build without the Bytes</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/buildbar-at-meroton-office/">BuildBar at the Meroton Office</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/remote-executors-for-free-tier/">Remote Executors for the Free Environment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tips-trix-and-nondeterminism/">Tips, Tricks &amp; Non-Deterministic Builds</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bb-deploy-updates-2022-04/">Updates to Buildbarn deployment repo as of April 2022</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/about/">Purpose of the Articles</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Memory Adventure</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-11-13T00:00:00.000Z">November 13, 2023</time> Â· <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo authorImage_XqGP" src="/img/nils-avatar.jpg" alt="Nils Wireklint"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Nils Wireklint</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>An adventure in finding a memory thief in Starlark-land</p>
<p>This is a summary and follow-up to <a href="https://www.youtube.com/watch?v=IXimf4DCAoY#t=7h21m57s" target="_blank" rel="noopener noreferrer">my talk</a> at BazelCon-2023.
With abridged code examples, the full instructions are available <a href="https://github.com/meroton/memory-adventure" target="_blank" rel="noopener noreferrer">together with the code</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="problem-statement">Problem Statement<a href="#problem-statement" class="hash-link" aria-label="Direct link to Problem Statement" title="Direct link to Problem Statement">â€‹</a></h2>
<p>First, we lament Bazel&#x27;s out-of-memory errors,
and point out that the often useful Starlark stacktrace does not always show up.
Some allocation errors just crash Bazel without giving and indication of which allocation failed.</p>
<p><img decoding="async" loading="lazy" alt="allocation" src="/assets/images/memory-allocation-failure-298bf3c0d8e472754fd513fa6c0ce57d.png" width="1358" height="952" class="img_ev3q"></p>
<p>This diagram illustrates a common problem for memory errors,
the allocation that fails may not be the problem,
it is just the straw that breaks the camel&#x27;s back.
And the real thief may already have allocated its memory.</p>
<p>We have seen many errors when working with clients,
and they typically hide in big corporate code bases.
Which complicates troubleshooting, discussion and error reporting.
So we create a synthetic repository to try to illustrate the problem,
and have something to discuss.
The code and instructions are available <a href="https://github.com/meroton/memory-adventure" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Errors and poor performance in the analysis phase
are not good at all.
This is because the analysis must always be done
before starting to build all actions.
With big projects the number of configuration to build for can be very large,
so one cannot rely on CI runners to build the same configuration over and over,
to retain the analysis cache.
Instead it is on the critical-path for all builds,
especially if the actions themselves are cached remotely.</p>
<p>To illustrate (some of the problem) we have a reproduction repository
with example code base with some Python and C programs.
To introduce memory problems, and make it a little more complex
we add two rules: one CPU intensive rule (&quot;spinlock&quot;)
and one memory intensive aspect (&quot;traverse&quot;).
The &quot;traverse&quot; aspect encodes the full dependency tree of all targets
and writes that to a file with <code>ctx.actions.write</code>.
So the allocations are tied to the Action object.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="toolbox">Toolbox<a href="#toolbox" class="hash-link" aria-label="Direct link to Toolbox" title="Direct link to Toolbox">â€‹</a></h2>
<p>We have a couple of tools available, many are discussed in the <a href="https://bazel.build/rules/performance#memory-profiling" target="_blank" rel="noopener noreferrer">memory optimization guide</a>,
but we find that some problems can slip through the cracks.</p>
<p>First off, there are the post-build analysis tools in bazel:</p>
<ul>
<li><code>bazel info</code></li>
<li><code>bazel dump --rules</code></li>
<li><code>bazel aquery --skyframe_state</code></li>
</ul>
<p>These are a good starting point and have served us well on many occasions.
But with this project they seem to miss some allocations
We will return to that later.
Additionally, these tool will not give any information if the Bazel server crashes.
You will need to increase the memory and run the same build again.</p>
<p>Then one can use Java tools to inspect what the JVM is doing:</p>
<ul>
<li><a href="https://eclipse.dev/mat/documentation/" target="_blank" rel="noopener noreferrer">Eclipse Memory Analyzer</a></li>
<li><code>jmap</code></li>
</ul>
<p>The best approach here is to ask Bazel to save the heap if it crashes,
so it can be analyzed post-mortem: <code>bazel --heap_dump_on_oom</code></p>
<p>And lastly, use Bazel&#x27;s profiling information:</p>
<ul>
<li><code>bazel --profile=profile.gz --generate_json_trace_profile --noslim_profile</code></li>
</ul>
<p>This contains structured information
and is written continuously to disk,
so if Bazel crashes we can still parse it,
we just need to discard partially truncated events.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="expected-memory-consumption">Expected Memory consumption<a href="#expected-memory-consumption" class="hash-link" aria-label="Direct link to Expected Memory consumption" title="Direct link to Expected Memory consumption">â€‹</a></h2>
<p>As the two rules write their string allocations to output files
we get a clear picture of the expected RAM usage (or at least a lower bound).</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ bazel clean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ bazel build \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --aspects @example//memory:eat.bzl%traverse \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --output_groups=default,eat_memory \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory intensive tree traversal (in KB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ find bazel-out/ -name &#x27;*.tree&#x27; | xargs du | cut -f1 | paste -sd &#x27;+&#x27; | bc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">78504</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CPU intensive spinlocks (in KB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ find bazel-out/ -name &#x27;*.spinlock&#x27; | xargs du | cut -f1 | paste -sd &#x27;+&#x27; | bc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3400</span><br></span></code></pre></div></div>
<p>Here is a table with the data:</p>
<table><thead><tr><th></th><th>Memory for each target</th><th>Total</th></tr></thead><tbody><tr><td>Memory intensive</td><td>0-17 MB</td><td>79 MB</td></tr><tr><td>CPU intensive</td><td>136 KB</td><td>3.4 MB</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reported-memory-consumption">Reported Memory Consumption<a href="#reported-memory-consumption" class="hash-link" aria-label="Direct link to Reported Memory Consumption" title="Direct link to Reported Memory Consumption">â€‹</a></h2>
<p>Next, we check with the diagnostic tools.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ bazel version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bazelisk version: development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Build label: 6.4.0</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bazel-dump---rules">Bazel dump --rules<a href="#bazel-dump---rules" class="hash-link" aria-label="Direct link to Bazel dump --rules" title="Direct link to Bazel dump --rules">â€‹</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ bazel $STARTUP_FLAGS --host_jvm_args=-Xmx&quot;10g&quot; dump --rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: this information is intended for consumption by developers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">only, and may change at any time. Script against it at your own risk!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RULE                              COUNT     ACTIONS          BYTES         EACH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cc_library                            4          17        524,320      131,080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">native_binary                         1           4        524,288      524,288</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cc_binary                             6          54        262,176       43,696</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">toolchain_type                       14           0              0            0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">toolchain                            74           0              0            0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ASPECT                             COUNT     ACTIONS          BYTES         EACH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">traverse                              85          81        262,432        3,087</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spinlock14                            35          66        524,112       14,974</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spinlock15                            35          66              0            0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre></div></div>
<p>First, there are some common rules that we do not care about here,
then we have the Aspects.
<code>traverse</code> is the memory intensive aspect,
which is applied on the command line
and <code>spinlock&lt;N&gt;</code> are the CPU intensive rules,
with identical implementations just numbered (there are 25 of them).</p>
<p>It is a little surprising that only one have allocations.
And the action count for each aspect does not make sense either,
as this is not a transitive aspect.
It just runs a single action each time the rule is instantiated.
The hypothesis is that this is a display problem,
with code shared between rules.
There are 25 rules, with 25 distinct implementation functions,
but they in turn call the same function with the action.
So the &quot;count&quot; and &quot;actions&quot; columns are glued together,
but the &quot;bytes&quot; is reported for just one of the rules (it would be bad if this was double-counted).</p>
<p>Either way,
the total number of bytes does not add up to what we expect.
Compare the output to the lower-bound determined before:</p>
<p>|  | Memory for each target | Total | Reported Total |
| ---- | ---- | ----------- |
| Memory intensive | 0-17 MB | 79 MB | 262 kB
| CPU intensive | 136 KB |  3.4 MB | 524 kB</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="skylark-memory-profile">Skylark Memory Profile<a href="#skylark-memory-profile" class="hash-link" aria-label="Direct link to Skylark Memory Profile" title="Direct link to Skylark Memory Profile">â€‹</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This is not part of the video.</p></div></div>
<p>The skylark memory profiler is much more advanced,
and can be dumped after a successful build.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ bazel $STARTUP_FLAGS --host_jvm_args=-Xmx&quot;$mem&quot; dump \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --skylark_memory=&quot;$dir/memory.pprof&quot;</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ pprof manual/2023-10-30/10g-2/memory.pprof</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Main binary filename not available.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type: memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time: Oct 30, 2023 at 12:16pm (CET)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Entering interactive mode (type &quot;help&quot; for commands, &quot;o&quot; for options)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(pprof) top</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Showing nodes accounting for 2816.70kB, 73.34% of 3840.68kB total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Showing top 10 nodes out of 19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     512kB 13.33% 13.33%      512kB 13.33%  impl2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.16kB  6.67% 20.00%   256.16kB  6.67%  traverse_impl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.11kB  6.67% 26.67%   256.11kB  6.67%  _add_linker_artifacts_output_groups</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.09kB  6.67% 33.34%   256.09kB  6.67%  alias</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.09kB  6.67% 40.00%   256.09kB  6.67%  rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.08kB  6.67% 46.67%   256.08kB  6.67%  to_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.06kB  6.67% 53.34%   256.06kB  6.67%  impl7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.04kB  6.67% 60.01%   256.04kB  6.67%  _is_stamping_enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.04kB  6.67% 66.67%   256.04kB  6.67%  impl18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  256.03kB  6.67% 73.34%   768.15kB 20.00%  cc_binary_impl</span><br></span></code></pre></div></div>
<p>Here the Memory intensive aspect shows up with 256kB,
which is inline with the output from <code>bazel dump --rules</code>,
but not reflecting the big allocations we know it makes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="eclipse-memory-analyzer">Eclipse Memory Analyzer<a href="#eclipse-memory-analyzer" class="hash-link" aria-label="Direct link to Eclipse Memory Analyzer" title="Direct link to Eclipse Memory Analyzer">â€‹</a></h3>
<p>The final tool we have investigated is the Java heap analysis tool
<a href="https://eclipse.dev/mat/documentation/" target="_blank" rel="noopener noreferrer">Eclipse Memory Analyzer</a>,
which can easily be used with Bazel&#x27;s <code>--heap_dump_on_oom</code> flag.
On the other hand it is a little tricker to find a heap dump from a successful build.</p>
<p><img decoding="async" loading="lazy" alt="eclipse-analysis" src="/assets/images/eclipse-memory-analyzer-5f46da77b0ac91a7a92dc4c2d3b445b3.png" width="1082" height="402" class="img_ev3q"></p>
<p>Here we see the (very) big allocation clear as day,
but have no information of its provenance.</p>
<p>We have not found how to track this back to a Skylark function, Skyframe evaluator
or anything that could be cross-referenced with the profiling information.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-time">Build Time<a href="#build-time" class="hash-link" aria-label="Direct link to Build Time" title="Direct link to Build Time">â€‹</a></h2>
<p>The next section of the talk shows the execution time of the build
with varying memory limits.</p>
<p><img decoding="async" loading="lazy" alt="combined" src="/assets/images/build-time-memory-plot-39f61e675034b7e845f9abdbfa8951f4.png" width="640" height="480" class="img_ev3q"></p>
<p>This is benchmarked with 5 data points for each memory limit,
and the plot shows failure if there was at least one crash among the data points.
There is a region where the build starts to succeed more and more often, but sometimes crashes.
So the Crash and not-crash graphs overlap a little,
you want to have some leeway to avoid flaky builds from occasional out-of-memory crashes.</p>
<p>We see that the Skymeld graph requires a lot less memory than a regular build,
that is because our big allocations are all tied to Action objects.
Enabling Skymeld lets Bazel start executing Actions as soon as they are ready,
so the resident set of Action objects does not grow so large,
and the allocations can be freed much sooner.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pessimization-with-limited-memory">Pessimization with limited memory<a href="#pessimization-with-limited-memory" class="hash-link" aria-label="Direct link to Pessimization with limited memory" title="Direct link to Pessimization with limited memory">â€‹</a></h2>
<p><img decoding="async" loading="lazy" alt="pessimization" src="/assets/images/low-memory-pessimization-667ab96247ad01ee0ec7d5b75b830d84.png" width="1212" height="827" class="img_ev3q"></p>
<p>We saw a hump in the build time for the Skymeld graph,
where the builds did succeed in the 300 - 400 MB range,
but the build speed gradually increased, reaching a plateau at around 500 MB.
This is a pattern we have seen before,
where more RAM, or more efficient rules can improve build performance.</p>
<p>This is probably because the memory pressure and the Java Garbage Collector
interferes with the Skyframe work.
See <a href="https://www.youtube.com/watch?v=8Dc8R_Zrf6M&amp;t=3039s" target="_blank" rel="noopener noreferrer">Benjamin Peterson&#x27;s great talk</a> about the Skyframe for more information.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="future-work">Future work<a href="#future-work" class="hash-link" aria-label="Direct link to Future work" title="Direct link to Future work">â€‹</a></h2>
<p><img decoding="async" loading="lazy" alt="example profile" src="/assets/images/example-chrome-tracing-424c445f4f5a56244ed23a270ba7c0c3.png" width="809" height="664" class="img_ev3q"></p>
<p>This section details future work for more tools and signals
that we can find from Bazel&#x27;s profile information
<code>--profile=profile.gz --generate_json_trace_profile --noslim_profile</code>.
Written in the standard <code>chrome://tracing</code> format
it is easy to parse for both successful and failed builds.</p>
<p>This contains events for the garbage collector,
and all executed Starlark functions.</p>
<p>These can be correlated
to find which functions are active during, or before, garbage collection events.
Additionally, one could collect this information for all failed builds,
and see if some functions are overrepresented
among the last active functions for each evaluator in the build.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/bazel/">bazel</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/buildbarn/">buildbarn</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/meroton/docs/edit/main/blog/2023-11-13-memory-adventure/2023-11-13-adventure.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/buildbarn-updates-2023-11/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Updates to Buildbarn as of November 2023</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/bazelcon-2023/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">BazelCon 2023</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#problem-statement" class="table-of-contents__link toc-highlight">Problem Statement</a></li><li><a href="#toolbox" class="table-of-contents__link toc-highlight">Toolbox</a></li><li><a href="#expected-memory-consumption" class="table-of-contents__link toc-highlight">Expected Memory consumption</a></li><li><a href="#reported-memory-consumption" class="table-of-contents__link toc-highlight">Reported Memory Consumption</a><ul><li><a href="#bazel-dump---rules" class="table-of-contents__link toc-highlight">Bazel dump --rules</a></li><li><a href="#skylark-memory-profile" class="table-of-contents__link toc-highlight">Skylark Memory Profile</a></li><li><a href="#eclipse-memory-analyzer" class="table-of-contents__link toc-highlight">Eclipse Memory Analyzer</a></li></ul></li><li><a href="#build-time" class="table-of-contents__link toc-highlight">Build Time</a></li><li><a href="#pessimization-with-limited-memory" class="table-of-contents__link toc-highlight">Pessimization with limited memory</a></li><li><a href="#future-work" class="table-of-contents__link toc-highlight">Future work</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/theory/components-of-a-build/">Theory</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">About Us</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/services/">Services</a></li><li class="footer__item"><a class="footer__link-item" href="/contact/">Contact</a></li><li class="footer__item"><a href="https://forms.gle/wchwDu6roWg6A7U29" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sign up<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/master-thesis/">Master Thesis</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Buildbarn Environments</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/services/managed-buildbarn/">Managed Buildbarn</a></li><li class="footer__item"><a class="footer__link-item" href="/services/supported-build-environment/">Supported Build Environment</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/bug-bounty/">Bug bounty</a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy/">Privacy Policy</a></li><li class="footer__item"><a href="https://github.com/meroton" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2025 Meroton AB</div></div></div></footer></div>
</body>
</html>